---
title: "Model_v1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Close graphics and clear local memory
graphics.off()
rm(list=ls())

#load libraries
library(ggplot2)
library(plyr)
library(data.table)
library(AER)
library(sandwich)
library(foreign)
library(rmarkdown)
library(lme4)
library(lmerTest)
library(lfe)

#load data
cover.climate=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/cover_climate.csv",header = T)) 

transect.master=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Transect_master_V2.csv",header = T)) #use V2 after data issue

#indices.yearly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Yearly.csv",header = T)) 

#indices.monthly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Monthly.csv",header = T)) 

options(max.print = 1000) #set print limit for expediency 

#relevel so it is relative to rest as y intercept
levels(cover.climate$Action)
cover.climate$Action = factor(cover.climate$Action, levels = c("Rest","Burn","Graze","Combo",""))

#Factorize TransectID, SITE_ID and Year 
cover.climate$Year = as.factor(cover.climate$Year)
cover.climate$TransectID = as.factor(cover.climate$TransectID)
cover.climate$MGMTUNIT_I = as.factor(cover.climate$MGMTUNIT_I)
cover.climate$SITE_ID = as.factor(cover.climate$SITE_ID)

#Remove Transects with blanks for Action, I don't think I will need this for the lagged models
cover.climate = cover.climate[!Action=="",]

#Create sub-cover files to match the model analysis. E.g. transect-level analysis should not include species rows, that would create too many replication ir_tran values
tran.dt       = unique(cover.climate[,.(Year,TransectID,SITE_ID,MGMTUNIT_I,Action,Delta,StartLat,StartLong,Long.Cat,Lat.Cat,ManUnitAcres,ObsCode,
                                          VOR, Litter, sr_tran,
                                          nr_tran, nf.tran, meanDI.n.tran.2,change_nr_tran, change_nf.tran, indf.n.tran, change_indf.n.tran,
                                          rel.cov.n.1.1,rel.cov.n.1.2, rel.cov.n.2, rel.cov.n.3, rel.cov.n.4,
                                          ir_tran,if.tran,meanDI.i.tran.2,change_ir_tran, change_if.tran,indf.i.tran, change_indf.i.tran,
                                          rel.cov.i.1.1,rel.cov.i.1.2,rel.cov.i.2,rel.cov.i.3,rel.cov.i.4,
                                          txx,tn90p, tx90p,rx5.winter,rx5.spring,rx5.summer,rx5.year,fd,gsl,wsdi,csdi,sdii,cdd,cwd,prcptot)])

mgmt.dt       =  unique(cover.climate[,.(Year,TransectID,SITE_ID,MGMTUNIT_I, Action, Delta,StartLat,StartLong,Long.Cat,Lat.Cat,ManUnitAcres,ObsCode,
                                          VOR, Litter, sr_mgmt,
                                          nr_mgmt, nf.mgmt,change_nr_mgmt, change_nf.mgmt,indf.n.mgmt, change_indf.n.mgmt, 
                                          ir_mgmt,if.mgmt,change_ir_mgmt, change_if.mgmt,indf.i.mgmt, change_indf.i.mgmt, 
                                          txx,tn90p, tx90p,rx5.winter,rx5.spring,rx5.summer,rx5.year,fd,gsl,wsdi,csdi,sdii,cdd,cwd,prcptot)])

i.species.dt    = cover.climate[Native.Status=="I",]
n.species.dt    = cover.climate[Native.Status=="N",]
all.species.dt  = cover.climate

```

#Index Key:
Yearly:
FD -Annual count of days when TN (daily minimum temperature) < 0°C  
SU - Annual count of days when TX (daily maximum temperature) > 25°C.  
ID - Annual count of days when TX (daily maximum temperature) < 0 °C.  
TR - Annual count of days when TN (daily minimum temperature) > 20 °C.   
GSL - Growing Season length. Annual* count between the first span of at least 6 days with daily mean temperature TG >5 °C and the first span after July 1st (Jan 1st in SH) of 6 days with TG <5 °C.  
WSDI - Warm spell duration index: annual count of days with at least 6 consecutive days when TX > 90th percentile  
CSDI - Cold spell duration index: annual count of days with at least 6 consecutive days when TN < 10th percentile  
SDII - Simple precipitation intensity index  
R10mm - Annual count of days when PRCP ≥ 10mm  
R20mm - Annual count of days when PRCP ≥ 20mm  
Rnnmm - Annual count of days when PRCP ≥ nn mm, where nn is a user-defined threshold  
CDD - Maximum length of dry spell: maximum number of consecutive days with RR < 1mm  
CWD - Maximum length of wet spell: maximum number of consecutive days with RR ≥ 1mm  
R95p - Annual total PRCP when RR > 95th percentile  
R99p - Annual total PRCP when RR > 99th percentile  
PRCPTOT - Annual total precipitation on wet days  

Monthly:
TXx - Monthly maximum value of daily maximum temperature  
TNx - Monthly maximum value of daily minimum temperature  
TXn - Monthly minimum value of daily minimum temperature  
TNn - Monthly minimum value of daily minimum temperature  
TN10p - Percentage of days when TN < 10th percentile  
TX10p - Percentage of days when TX < 10th percentile  
TN90p - Percentage of days when TN > 90th percentile  
TX90p - Percentage of days when TX > 90th percentile
DTR - Daily temperature range  
Rx1day - Monthly maximum 1-day precipitation  
Rx5day - Monthly maximum consecutive 5-day precipitation  


##Models Set 1  - Invasive Species
Create a linear model to explain invasive species values.

Dependent Variable
A = Invasive abundance at transect; either:
  •	Invasive Richness
  •	Invasive Frequency
  •	Cumulative invasive cover
  •	Dominance Indicator 
 
Independent Variables
C = Climate indices 
  •	Yearly
  •	Monthly
O = Observer 
  •	Coded observer factor
M = Management action
  •	Categorical factor 
D = Management Timing
  •	Day of the Year
  •	Categorical Season description
T = Transect
  •	Factorized Transect ID
Y = Year
  •	Factorized year of observation and management action

put in transect as a factor

Other time-dependent independent variables to consider: transect diversity/SR, particularly native sr; legume presence; transect productivity (VOR)
    
#Model Formula
Aji = β0 + β1Mij + β2Dij + β3Cij + β4Tij+ β5Yij+ β6Oij  + β7MDCit + Vio + Vi1Tij + Vi2Yij + Vi3Oit + eij

Where:
ij =  per transect measurement per year
e = random unobserved error
β0 = Per transect intercept


#Run Model

```{r Invasives-lm}
#Start with modeling invasive abundance

options(max.print = 60)

#run one model without climate
lm.ir.1 = lm(data = tran.dt , formula = ir_tran ~ Action + ObsCode + TransectID )
summary(lm.ir.1)

lm.if.1 = lm(data = tran.dt , formula = if.tran ~ Action + ObsCode + TransectID )
summary(lm.if.1)

lm.di.i.1 = lm(data = tran.dt , formula = meanDI.I_tran ~ Action + ObsCode + TransectID )
summary(lm.di.i.1)

par(mfrow=c(2,2))
plot(lm.ir.1)

plot(lm.if.1)

plot(lm.di.i.1)


#Consider correlations between indices and inputting multiple in one model. Scatter plot between independent variables
library(GGally)
x=tran.dt[,.(Action,ObsCode,TransectID)]
ggpairs(x)


```

###Mixed-effect multivariate models

The above models are simple linear multivariable linear regressions, but I need to treat variable according to whether they are random or fixed effects.

Create a mixed effect model for each metric of invasive abundance (richness, frequency, total relative cover, and dominance) and for each climate index of interest.

##Start with TXx (max temperature - calculate for year) 

#Txx mixed effects
```{r Invasives-ME-TXX}

###Explore linear relationship between TXx and Abundance 

#IR
txx.ir.lm.1 = lm(ir_tran ~ 1 + txx, data = tran.dt)

summary(txx.ir.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.ir.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.ir.lm.1)

#F
txx.if.lm.1 = lm(if.tran ~ 1 + txx, data = tran.dt)

summary(txx.if.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.if.lm.1)


#Mean DI
txx.DI.lm.1 = lm( meanDI.I_tran ~ 1 + txx, data = tran.dt)

summary(txx.DI.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.DI.lm.1)



###Add more independent variables to this regression

#IR
txx.ir.lm.2 = lm(ir_tran ~ Action + txx, data = tran.dt)

summary(txx.ir.lm.2)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.ir.lm.2)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.ir.lm.2)

#F
txx.if.lm.2 = lm(if.tran ~ Action + txx, data = tran.dt)

summary(txx.if.lm.2)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.2)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.if.lm.2)

#Mean DI
txx.DI.lm.2 = lm( meanDI.I_tran ~ Action + txx, data = tran.dt)

summary(txx.DI.lm.2)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.2)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.DI.lm.2)



####Add some interaction to the model

#IR
txx.ir.lm.3 = lm(ir_tran ~ Action + txx + Action*txx, data = tran.dt)

summary(txx.ir.lm.3)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.ir.lm.3)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.ir.lm.3)

#F
txx.if.lm.3 = lm(if.tran ~ Action + txx + Action*txx, data = tran.dt)

summary(txx.if.lm.3)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.3)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.if.lm.3)

#Mean DI
txx.DI.lm.3 = lm( meanDI.I_tran ~ Action + txx + Action*txx, data = tran.dt)

summary(txx.DI.lm.3)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.if.lm.3)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.DI.lm.3)



#########################Now consider transect as a fixed effect, create a strong global model

#### First with the Lme4 package

#For discussion with Laura...data is limited by years we have climate data for an missing the 2019 data which will give us more years. That being said, there still is not a lot of variabiation in action type - see lines below. I imagine if looked at some sort of management frequency this would be less of an issue.
tran.dt[,length(unique(Year)),by=Action]

tran.dt[,length(unique(Action)),by=Year]

tran.dt[,length(unique(Action)),by=.(Year,SITE_ID)]

#IR
txx.ir.lmer.1 = lmer(ir_tran ~ Action*txx + txx + VOR + nr_tran + (1|SITE_ID), data = tran.dt)

summary(txx.ir.lmer.1)

#F
txx.if.lmer.1 = lmer(if.tran ~  txx + SITE_ID + VOR + nr_tran + Action*txx + (1|ObsCode), data = tran.dt)

summary(txx.if.lmer.1)

#Mean DI
txx.DI.lmer.1 = lmer( meanDI.I_tran ~ txx + SITE_ID + VOR + nr_tran + Action:txx + (1|ObsCode), data = tran.dt)

summary(txx.DI.lmer.1)


###Now with LFE package

#IR
txx.ir.flm.1 = felm(ir_tran ~ Action:txx + txx + VOR + nr_tran + ObsCode | SITE_ID, data = tran.dt)
summary(txx.ir.flm.1)

txx.ir.flm.2 = felm(ir_tran ~ Action:txx + txx | TransectID, data = tran.dt) #rank-deficient
summary(txx.ir.flm.2)

txx.ir.flm.3 = felm(ir_tran ~ Action:txx + txx | SITE_ID + ObsCode, data = tran.dt) #Ru
summary(txx.ir.flm.3)

#IF
txx.if.flm.1 = felm(if.tran ~ Action:txx + txx + VOR + nr_tran + ObsCode | SITE_ID, data = tran.dt)
summary(txx.if.flm.1)

#DI
txx.di.flm.1 = felm(meanDI.i.tran.2 ~ Action:txx + txx + VOR + nr_tran + ObsCode | SITE_ID, data = tran.dt)
summary(txx.if.flm.1)


```

#Txx Lagged Effects
```{r Invasives-LE-txx}

```



#Now create a model for TN90p. 

This is a monthly value for the percentage of days when TN > 90th percentile. I care about these values for the whole of winter, create a new value which either add or average these values for the winter months. 

```{r Model Set 3 - Invasives-TN90p}

#Explore linear relationship between tn90p and Abundance (IR)

tn90p.lm.1 = lm(ir_tran ~ 1 + val.mth, data = tran.dt)

summary(tn90p.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(tn90p.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(tn90p.lm.1)

#Add more independent variables to this regression
tn90p.lm.2 = lm(ir_tran ~ Action + val.mth, data = tran.dt)

summary(tn90p.lm.2)

par(mfrow=c(2,2)) #
plot(tn90p.lm.2) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(tn90p.lm.2)

#Add some interaction to the model
tn90p.lm.3 = lm(ir_tran ~  Action + val.mth + Action*val.mth, data = tran.dt)

summary(tn90p.lm.3)

par(mfrow=c(2,2)) #
plot(tn90p.lm.3) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(tn90p.lm.3)



#Now consider transect as a fixed effect, create a strong global model
tn90p.lm.4 = lmer(formula = ir_tran ~  Action + val.mth + as.factor(TransectID) + VOR +  Action*val.mth + (1|ObsCode), 
                data = tran.dt)

summary(tn90p.lm.4)

tn90p.flm.4 = felm(ir_tran ~   val.mth + Action | TransectID,  
                data = tran.dt)

summary(tn90p.flm.4)

par(mfrow=c(2,2)) #
plot(tn90p.lm.4) 
par(mfrow=c(1,1)) 
AIC(tn90p.lm.4)

```


#


Write out a long logic portion of the methods, so the model and what indices
