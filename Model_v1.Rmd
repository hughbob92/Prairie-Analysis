---
title: "Model_v1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Close graphics and clear local memory
graphics.off()
rm(list=ls())

#load libraries
library(ggplot2)
library(plyr)
library(data.table)
library(AER)
library(sandwich)
library(foreign)
library(rmarkdown)
library(lme4)
library(lmerTest)

#load data
cover=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Cover_data_model.csv",header = T)) 

transect.master=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Transect_master_V2.csv",header = T)) #use V2 after data issue

Indices.Yearly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Yearly.csv",header = T)) 

Indices.Monthly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Monthly.csv",header = T)) 

#add in TransectIDs to Indices lists
z = transect.master[,.(Transect_I,TransectNa)]
setnames(z,c("Transect_I","TransectNa"),c("TransectID","Transect"))
Indices.Monthly = merge(Indices.Monthly,z, by = "Transect", all = T)
Indices.Monthly[,Transect:=NULL]
Indices.Yearly = merge(Indices.Yearly,z, by = "Transect", all = T)
Indices.Yearly[,Transect:=NULL]

setnames(Indices.Monthly,c("variable", "value","Index"),c("Year","val.mth","Index.m"),skip_absent=TRUE)
setnames(Indices.Yearly,c("variable", "value","Index"),c("Year","val.yr","Index.y"),skip_absent=TRUE)

options(max.print = 50) #set print limit for expediency 

#relevel so it is relative to rest as y intercept
levels(cover$Action)
cover$Action = factor(cover$Action, levels = c("Rest","Burn","Graze","Combo",""))
```

##Models Set 1  - Invasive Species
Create a linear model to explain invasive species values.

Dependent Variable
A = Invasive abundance at transect; either:
  •	Invasive Richness
  •	Invasive Frequency
  •	Cumulative invasive cover
  •	Dominance Indicator 
 
Independent Variables
C = Climate indices 
  •	Yearly
  •	Monthly
O = Observer 
  •	Coded observer factor
M = Management action
  •	Categorical factor 
D = Management Timing
  •	Day of the Year
  •	Categorical Season description
T = Transect
  •	Factorized Transect ID
Y = Year
  •	Factorized year of observation and management action


put in transect as a factor

Other time-dependent independent variables to consider: transect diversity/SR, particularly native sr; legume presence; transect productivity (VOR)
    
#Model Formula
Aji = β0 + β1Mij + β2Dij + β3Cij + β4Tij+ β5Yij+ β6Oij  + β7MDCit + Vio + Vi1Tij + Vi2Yij + Vi3Oit + eij

Where:
ij =  per transect measurement per year
e = random unobserved error
β0 = Per transect intercept


#Index Key:
Yearly:
FD -Annual count of days when TN (daily minimum temperature) < 0°C  
SU - Annual count of days when TX (daily maximum temperature) > 25°C.  
ID - Annual count of days when TX (daily maximum temperature) < 0 °C.  
TR - Annual count of days when TN (daily minimum temperature) > 20 °C.   
GSL - Growing Season length. Annual* count between the first span of at least 6 days with daily mean temperature TG >5 °C and the first span after July 1st (Jan 1st in SH) of 6 days with TG <5 °C.  
WSDI - Warm spell duration index: annual count of days with at least 6 consecutive days when TX > 90th percentile  
CSDI - Cold spell duration index: annual count of days with at least 6 consecutive days when TN < 10th percentile  
SDII - Simple precipitation intensity index  
R10mm - Annual count of days when PRCP ≥ 10mm  
R20mm - Annual count of days when PRCP ≥ 20mm  
Rnnmm - Annual count of days when PRCP ≥ nn mm, where nn is a user-defined threshold  
CDD - Maximum length of dry spell: maximum number of consecutive days with RR < 1mm  
CWD - Maximum length of wet spell: maximum number of consecutive days with RR ≥ 1mm  
R95p - Annual total PRCP when RR > 95th percentile  
R99p - Annual total PRCP when RR > 99th percentile  
PRCPTOT - Annual total precipitation on wet days  

Monthly:
TXx - Monthly maximum value of daily maximum temperature  
TNx - Monthly maximum value of daily minimum temperature  
TXn - Monthly minimum value of daily minimum temperature  
TNn - Monthly minimum value of daily minimum temperature  
TN10p - Percentage of days when TN < 10th percentile  
TX10p - Percentage of days when TX < 10th percentile  
TN90p - Percentage of days when TN > 90th percentile  
TX90p - Percentage of days when TX > 90th percentile
DTR - Daily temperature range  
Rx1day - Monthly maximum 1-day precipitation  
Rx5day - Monthly maximum consecutive 5-day precipitation  

#Run Model

```{r Model Set 1 - Invasives}
#Start with modeling invasive richness

#Subset cover file and merge 
dt.lm.1.1 = unique(cover[!(is.na(ir_tran)) & !(Action==""),
                         .(TransectID,MGMTUNIT_I,SITE_ID,Year,StartLat,StartLong,Lat.Cat,Long.Cat,Action,
                           Delta,ObsCode,ir_tran,ir_mgmt,change_ir_tran,change_ir_mgmt,VOR,nr_tran)])

#run one model without climate
lm.1.1 = lm(data = dt.lm.1.1, 
            formula = ir_tran ~ Action + ObsCode + as.factor(TransectID) )
summary(lm.1.1)

par(mfrow=c(2,2))
plot(lm.1.1)

#Consider correlations between indices and inputting multiple in one model. Scatter plot between independent variables
library(GGally)
x=dt.lm.1.1[,.(Action,ObsCode,TransectID)]
ggpairs(x)

#Now merge climate indices in and run a model for each index....still need 2017 and 2018 climate indices
dt.lm.1.2 = merge(dt.lm.1.1,Indices.Yearly,by = c("Year","TransectID"))
dt.lm.1.3 = merge(dt.lm.1.1,Indices.Monthly,by = c("Year","TransectID"))


#create a list of yearly indices to loop through
ind.y.list = dt.lm.1.2[,unique(Index.y)]

#Loop through yearly indices
lm.1.2 =list()
aic.lm.1.2 = c()
index.name = c()
step.lm.1.2 = list()

for (i in 1:length(ind.y.list)) {
  z = lm(data = dt.lm.1.2[Index.y==as.character(ind.y.list[i]),], 
         formula = ir_tran ~ Action + ObsCode + val.yr + as.factor(TransectID))
  lm.1.2[[i]] = summary(z)
  index.name = c(index.name,as.character(ind.y.list[i]))
  aic.lm.1.2 = c(aic.lm.1.2,AIC(z))
  #step.lm.1.2[[i]] = step(z)
  }
aic.lm.1.2 = data.frame(index.name,aic.lm.1.2)
names(lm.1.2) = ind.y.list

#Examine collinearity
x=dcast(dt.lm.1.2[,.(Year,TransectID,Action,Index.y,val.yr)],Year+TransectID+Action~Index.y,value.var="val.yr")
ggpairs(x[,3:dt.lm.1.2[,length(unique(Index.y))]])
#Look at Variance inflation factor
library(faraway)
vif(lm.1.1) #needs work


#create a list of monthly indices to loop through
ind.m.list = dt.lm.1.3[,unique(Index.m)]

#Loop through monthly indices and months!
lm.1.3 =list()
aic.lm.1.3 = c()
index.name = c()
step.lm.1.3 = list()

for (i in 1:length(ind.m.list)) {
  z = lm(data = dt.lm.1.3[Index.m==as.character(ind.m.list[i]),], 
         formula = ir_tran ~ Action + ObsCode + val.mth + as.factor(TransectID))
  lm.1.3[[i]] = summary(z)
  index.name = c(index.name,as.character(ind.m.list[i]))
  aic.lm.1.3 = c(aic.lm.1.3,AIC(z))
  step.lm.1.3[[i]] = step(z)
  }
aic.lm.1.3 = data.frame(index.name,aic.lm.1.3)
names(lm.1.3) = ind.m.list

```

##Mixed-effect multivariate models

The above models are simple linear multivariable linear regressions, but I need to treat variable according to whether they are random or fixed effects.

Create a mixed effect model for each metric of invasive abundance (richness, frequency, total relative cover, and dominance) and for each climate index of interest.

#Start with TXx (max temperature - calculate for year) 

```{r Model Set 2 - Invasives-TXx}
#First determine the max tempt (TXx) for each transect and each year. This is originally a monthly value.
txx = Indices.Monthly[Index.m=="txx" & Year>2009,.SD[which.max(val.mth)],by=.(Year,TransectID)]

table(txx$Year,txx$Month) #See how max temperatures are divided between months each year. There is a case here for just taking txx for July...but August also has an impact.

#Merge txx with cover
dt.cover.txx = merge(cover,txx, by=c("Year","TransectID"))

#I don't care about Plot ID, reduce the cover table by unique values...I will still have duplicates because of NAs but that is okay for now
dt.cover.txx[,PlotID:=NULL]
dt.cover.txx = unique(dt.cover.txx[,])

dt.cover.txx.1 = dt.cover.txx[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] #for some reason nr_tran has NA values, correct
dt.cover.txx.2 = dt.cover.txx[!(is.na(if.tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran,if.tran, VOR, nr_tran,nf.tran,ObsCode)] 
#build out for cover dt.cover.txx.3 = dt.cover.txx[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] 
#build out for dominance dt.cover.txx.4 = dt.cover.txx[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] 

#visualize txx variability....hmm not a whole lot of variability here. 
ggplot(dt.cover.txx.1, aes(x=val.mth)) +
  geom_histogram(binwidth=1,color="black", fill="white") +
  facet_wrap(~Year)

#how do these values vary spatially? Use latitude since that is more likely predicted to correlate with temp
ggplot(dt.cover.txx.1, aes(x=val.mth,color=Lat.Cat,fill=Lat.Cat)) +
  geom_histogram(binwidth=1,alpha=0.5, position="identity") +
  facet_wrap(~Year)

#How about variability between action types
ggplot(dt.cover.txx.1, aes(x=val.mth,color=Action,fill=Action)) +
  geom_histogram(binwidth=1,alpha=0.5, position="identity") +
  facet_wrap(~Year)

#Visualize a simple relationship between abundace (IR, IF, IR rel cover, IR dominance) and TXx
#
ggplot(dt.cover.txx.1, aes(x=val.mth,y=ir_tran, color=Action, group = Action)) +
  geom_point(size=0.3, alpha = 0.5,position="jitter")+
  theme_minimal()+
  theme(legend.position = "none")+
  geom_smooth(method = lm,
             se = FALSE,
              size = 1,
              alpha = 1)+
  labs(title    = "Invasive Richness vs. Max Yearly Temp (TXx)", x="Max Temp (C)", y="Transect Invasive Richness")

ggplot(dt.cover.txx.2, aes(x=val.mth,y=if.tran, color=Action, group = Action)) +
  geom_point(size=0.3, alpha = 0.5,position="jitter")+
  theme_minimal()+
  theme(legend.position = "none")+
  geom_smooth(method = lm,
             se = FALSE,
              size = 1,
              alpha = 1)+
  labs(title = "Invasive Frequency vs. Max Yearly Temp (TXx)", x="Max Temp (C)", y="Transect Invasive Frequency")


#Explore same for NR
ggplot(unique(dt.cover.txx[!(is.na(if.tran)),.(Year,TransectID,val.mth,Action,if.tran)]), 
       aes(x=val.mth,y=if.tran, color=Action)) +
geom_point(position="jitter")

ggplot(unique(dt.cover.txx.1), 
       aes(x=val.mth,y=nr_tran, color=Action)) +
geom_point(position="jitter")

#Explore linear relationship between TXx and Abundance (IR)

txx.lm.1 = lm(ir_tran ~ 1 + val.mth, data = dt.cover.txx.1)

summary(txx.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(txx.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(txx.lm.1)

#Add more independent variables to this regression
txx.lm.2 = lm(ir_tran ~ Action + val.mth, data = dt.cover.txx.1)

summary(txx.lm.2)

par(mfrow=c(2,2)) #
plot(txx.lm.2) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(txx.lm.2)

#Add some interaction to the model
txx.lm.3 = lm(ir_tran ~  Action + val.mth + Action*val.mth, data = dt.cover.txx.1)

summary(txx.lm.3)

par(mfrow=c(2,2)) #
plot(txx.lm.3) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(txx.lm.3)

#Now consider transect as a fixed effect, create a strong global model
txx.lm.4 = lmer(formula = ir_tran ~  Action + val.mth + as.factor(TransectID) + VOR +  Action*val.mth + (1|ObsCode), 
                data = dt.cover.txx.1)

summary(txx.lm.4)


par(mfrow=c(2,2)) #
plot(txx.lm.4) 
par(mfrow=c(1,1)) 
AIC(txx.lm.4)

```

#Now create a model for TN90p. 

This is a monthly value for the percentage of days when TN > 90th percentile. I care about these values for the whole of winter, create a new value which either add or average these values for the winter months. 

```{r Model Set 3 - Invasives-TN90p}
#First sum tn90p values for winter "dormant" months, let's say Decemeber - March
tn90p = Indices.Monthly[Index.m=="tn90p" & Year>2009 & (Month =="Dec" | Month == "Jan" | Month == "Feb" | Month=="Mar"),sum(val.mth)/4,by=.(Year,TransectID)]
setnames(tn90p,"V1","val.mth")

#Merge tn90p with cover
dt.cover.tn90p = merge(cover,tn90p, by=c("Year","TransectID"))

#I don't care about Plot ID, reduce the cover table by unique values...I will still have duplicates because of NAs but that is okay for now
dt.cover.tn90p[,PlotID:=NULL]
dt.cover.tn90p = unique(dt.cover.tn90p[,])

dt.cover.tn90p.1 = dt.cover.tn90p[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] #for some reason nr_tran has NA values, correct
dt.cover.tn90p.2 = dt.cover.tn90p[!(is.na(if.tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran,if.tran, VOR, nr_tran,nf.tran,ObsCode)] 
#build out for cover dt.cover.txx.3 = dt.cover.txx[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] 
#build out for dominance dt.cover.txx.4 = dt.cover.txx[!(is.na(ir_tran)) & !(Action==""), .(Year,TransectID, val.mth, Action, ir_tran, VOR, nr_tran,ObsCode)] 

#visualize tn90p variability
ggplot(dt.cover.tn90p.1, aes(x=val.mth)) +
  geom_histogram(binwidth=1,color="black", fill="white") 

ggplot(dt.cover.tn90p.1, aes(x=val.mth)) +
  geom_histogram(binwidth=1,color="black", fill="white") +
  facet_wrap(~Year)

#How about variability between action types
ggplot(dt.cover.tn90p.1, aes(x=val.mth,color=Action,fill=Action)) +
  geom_histogram(binwidth=1,alpha=0.5, position="identity") +
  facet_wrap(~Year)

#Visualize a simple relationship between abundace (IR, IF, IR rel cover, IR dominance) and tn90p
ggplot(dt.cover.tn90p.1, aes(x=val.mth,y=ir_tran, color=Action, group = Action)) +
  geom_point(size=0.3, alpha = 0.5,position="jitter")+
  theme_minimal()+
  theme(legend.position = "none")+
  geom_smooth(method = lm,
             se = FALSE,
              size = 1,
              alpha = 1)+
  labs(title    = "Invasive Richness vs. Percentage of Abnormally Warm Daily Lows", x="% Winter days with coldestt temp in 90th percentile", y="Transect Invasive Richness")

ggplot(dt.cover.tn90p.2, aes(x=val.mth,y=if.tran, color=Action, group = Action)) +
  geom_point(size=0.3, alpha = 0.5,position="jitter")+
  theme_minimal()+
  theme(legend.position = "none")+
  geom_smooth(method = lm,
             se = FALSE,
              size = 1,
              alpha = 1)+
  labs(title = "Invasive Frequency vs. Percentage of Abnormally Warm Daily Lows", x="% Winter days with coldestt temp in 90th percentile", y="Transect Invasive Frequency")


#Explore linear relationship between tn90p and Abundance (IR)

tn90p.lm.1 = lm(ir_tran ~ 1 + val.mth, data = dt.cover.tn90p.1)

summary(tn90p.lm.1)

par(mfrow=c(2,2)) # Change the panel layout to 2 x 2
plot(tn90p.lm.1)
par(mfrow=c(1,1)) # Change back to 1 x 1

AIC(tn90p.lm.1)

#Add more independent variables to this regression
tn90p.lm.2 = lm(ir_tran ~ Action + val.mth, data = dt.cover.tn90p.1)

summary(tn90p.lm.2)

par(mfrow=c(2,2)) #
plot(tn90p.lm.2) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(tn90p.lm.2)

#Add some interaction to the model
tn90p.lm.3 = lm(ir_tran ~  Action + val.mth + Action*val.mth, data = dt.cover.tn90p.1)

summary(tn90p.lm.3)

par(mfrow=c(2,2)) #
plot(tn90p.lm.3) # This looks pretty weird, what's going on here?
par(mfrow=c(1,1)) 
AIC(tn90p.lm.3)

#Now consider transect as a fixed effect, create a strong global model
tn90p.lm.4 = lmer(formula = ir_tran ~  Action + val.mth + as.factor(TransectID) + VOR +  Action*val.mth + (1|ObsCode), 
                data = dt.cover.tn90p.1)

summary(tn90p.lm.4)


par(mfrow=c(2,2)) #
plot(tn90p.lm.4) 
par(mfrow=c(1,1)) 
AIC(tn90p.lm.4)

```



Write out a long logic portion of the methods, so the model and what indices
