---
title: "Model_v1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Close graphics and clear local memory
graphics.off()
rm(list=ls())

#load libraries
library(ggplot2)
library(plyr)
library(data.table)
library(AER)
library(sandwich)
library(foreign)
library(rmarkdown)
library(lme4)
library(lmerTest)

#load data
cover=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Cover_data_model.csv",header = T)) 

transect.master=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Transect_master_V2.csv",header = T)) #use V2 after data issue

Indices.Yearly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Yearly.csv",header = T)) 

Indices.Monthly=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Monthly.csv",header = T)) 

#add in TransectIDs to Indices lists
z = transect.master[,.(Transect_I,TransectNa)]
setnames(z,c("Transect_I","TransectNa"),c("TransectID","Transect"))
Indices.Monthly = merge(Indices.Monthly,z, by = "Transect", all = T)
Indices.Monthly[,Transect:=NULL]
Indices.Yearly = merge(Indices.Yearly,z, by = "Transect", all = T)
Indices.Yearly[,Transect:=NULL]

setnames(Indices.Monthly,c("variable", "value","Index"),c("Year","val.mth","Index.m"),skip_absent=TRUE)
setnames(Indices.Yearly,c("variable", "value","Index"),c("Year","val.yr","Index.y"),skip_absent=TRUE)
```

##Models Set 1  - Invasive Species
Create a linear model to explain invasive species values.

Response variables: A
  - Invasive richness (transect and mgmt units)
      o All invasives or indicator species
      
  - Invasive Frequency (transect and mgmt unit)
      o Avg and individual species
      o All invasives or indicator species

  - Cover (transect and mgmt units)
    o Avg and individual species - relative cover
    
  - Dominance
    o aggregate invasive cover by dominance
    
Treatment Variables
  - Climate indices (C)
    o Yearly
    o Selected monthly (or all)
  - Soil Type (S)
  - Observer (O)
  - Management action (current year and prior years) (M)
  - Management Timing (D)
  - System Type (T)
  - Latitude
  - Longitude

Can think of demeaning - put in transect as a factor

Other treatment variables to consider: Size of management area, 
    
#Model Formula
Aist = βi + β1Mit + β2Tit + β3Cit + β4S +  β5D + β6M*T*C*D

#Index Key:
Yearly:
FD -Annual count of days when TN (daily minimum temperature) < 0°C  
SU - Annual count of days when TX (daily maximum temperature) > 25°C.  
ID - Annual count of days when TX (daily maximum temperature) < 0 °C.  
TR - Annual count of days when TN (daily minimum temperature) > 20 °C.   
GSL - Growing Season length. Annual* count between the first span of at least 6 days with daily mean temperature TG >5 °C and the first span after July 1st (Jan 1st in SH) of 6 days with TG <5 °C.  
WSDI - Warm spell duration index: annual count of days with at least 6 consecutive days when TX > 90th percentile  
CSDI - Cold spell duration index: annual count of days with at least 6 consecutive days when TN < 10th percentile  
SDII - Simple precipitation intensity index  
R10mm - Annual count of days when PRCP ≥ 10mm  
R20mm - Annual count of days when PRCP ≥ 20mm  
Rnnmm - Annual count of days when PRCP ≥ nn mm, where nn is a user-defined threshold  
CDD - Maximum length of dry spell: maximum number of consecutive days with RR < 1mm  
CWD - Maximum length of wet spell: maximum number of consecutive days with RR ≥ 1mm  
R95p - Annual total PRCP when RR > 95th percentile  
R99p - Annual total PRCP when RR > 99th percentile  
PRCPTOT - Annual total precipitation on wet days  

Monthly:
TXx - Monthly maximum value of daily maximum temperature  
TNx - Monthly maximum value of daily minimum temperature  
TXn - Monthly minimum value of daily minimum temperature  
TNn - Monthly minimum value of daily minimum temperature  
TN10p - Percentage of days when TN < 10th percentile  
TX10p - Percentage of days when TX < 10th percentile  
TN90p - Percentage of days when TN > 90th percentile  
TX90p - Percentage of days when TX > 90th percentile
DTR - Daily temperature range  
Rx1day - Monthly maximum 1-day precipitation  
Rx5day - Monthly maximum consecutive 5-day precipitation  

#Run Model

```{r Model Set 1 - Invasives}
#Start with modeling invasive richness

#relevel so it is relative to rest as y intercept
levels(cover$Action)
relevel(cover$Action,"Rest")

#Subset cover file and merge 
dt.lm.1.1 = unique(cover[!(is.na(ir_tran)) & !(Action==""),
                         .(TransectID,MGMTUNIT_I,SITE_ID,Year,StartLat,StartLong,Lat.Cat,Long.Cat,Action,
                           Delta,ObsCode,ir_tran,ir_mgmt,change_ir_tran,change_ir_mgmt)])

dt.lm.1.1$Action <- factor(dt.lm.1.1$Action, levels = c("Rest","Burn","Graze",""))

#run one model without climate
lm.1.1 = lm(data = dt.lm.1.1, 
            formula = ir_tran ~ Action + ObsCode + as.factor(TransectID) )
summary(lm.1.1)
step(lm.1.1)

par(mfrow=c(2,2))
plot(lm.1.1)

#Consider correlations between indices and inputting multiple in one model. Scatter plot between independent variables
library(GGally)
x=dt.lm.1.1[,.(Action,ObsCode,TransectID)]
ggpairs(x)

#Now merge climate indices in and run a model for each index....still need 2017 and 2018 climate indices
dt.lm.1.2 = merge(dt.lm.1.1,Indices.Yearly,by = c("Year","TransectID"))
dt.lm.1.3 = merge(dt.lm.1.1,Indices.Monthly,by = c("Year","TransectID"))

dt.lm.1.2$Action <- factor(dt.lm.1.2$Action, levels = c("Rest","Burn","Graze",""))
dt.lm.1.3$Action <- factor(dt.lm.1.3$Action, levels = c("Rest","Burn","Graze",""))

#create a list of yearly indices to loop through
ind.y.list = dt.lm.1.2[,unique(Index.y)]

#Loop through yearly indices
lm.1.2 =list()
aic.lm.1.2 = c()
index.name = c()
step.lm.1.2 = list()

for (i in 1:length(ind.y.list)) {
  z = lm(data = dt.lm.1.2[Index.y==as.character(ind.y.list[i]),], 
         formula = ir_tran ~ Action + ObsCode + val.yr + as.factor(TransectID))
  lm.1.2[[i]] = summary(z)
  index.name = c(index.name,as.character(ind.y.list[i]))
  aic.lm.1.2 = c(aic.lm.1.2,AIC(z))
  #step.lm.1.2[[i]] = step(z)
  }
aic.lm.1.2 = data.frame(index.name,aic.lm.1.2)
names(lm.1.2) = ind.y.list

#Examine collinearity
x=dcast(dt.lm.1.2[,.(Year,TransectID,Action,Index.y,val.yr)],Year+TransectID+Action~Index.y,value.var="val.yr")
ggpairs(x[,3:dt.lm.1.2[,length(unique(Index.y))]])
#Look at Variance inflation factor
library(faraway)
vif(lm.1.1) #needs work


#create a list of monthly indices to loop through
ind.m.list = dt.lm.1.3[,unique(Index.m)]

#Loop through monthly indices and months!
lm.1.3 =list()
aic.lm.1.3 = c()
index.name = c()
step.lm.1.3 = list()

for (i in 1:length(ind.m.list)) {
  z = lm(data = dt.lm.1.3[Index.m==as.character(ind.m.list[i]),], 
         formula = ir_tran ~ Action + ObsCode + val.mth + as.factor(TransectID))
  lm.1.3[[i]] = summary(z)
  index.name = c(index.name,as.character(ind.m.list[i]))
  aic.lm.1.3 = c(aic.lm.1.3,AIC(z))
  step.lm.1.3[[i]] = step(z)
  }
aic.lm.1.3 = data.frame(index.name,aic.lm.1.3)
names(lm.1.3) = ind.m.list

```

##Mixed-effect multivariate models

The above models are simple linear multivariable linear regressions, but I need to treat variable according to whether they are random or fixed effects.

Create and hone in a mixed effect model for each metric of invasive abundance (richness, frequency,  total relative cover, and dominance) and for each climate index of interest.

#Start with TXx (max temperature - calculate for year) 

```{r Model Set 2 - Invasives - TXx}
#First determine the max tempt (TXx) for each transect and each year. This is originally a monthly value.
txx = Indices.Monthly[Index.m=="txx" & Year>2009,.SD[which.max(val.mth)],by=.(Year,TransectID)]

table(txx$Year,txx$Month) #See how max temperatures are divided between months each year. There is a case here for just taking txx for July...but August also has an impact.

#Merge txx with cover
dt.cover.txx = merge(cover,txx, by=c("Year","TransectID"))

#I don't care about Plot ID, reduce the cover table by unique values...I will still have duplicates because of NAs but that is okay for now
dt.cover.txx[,PlotID:=NULL]
dt.cover.txx = unique(dt.cover.txx[,])

#visualize txx variability....hmm not a whole lot of variability here. 
ggplot(unique(dt.cover.txx[,.(Year,TransectID,val.mth)]), aes(x=val.mth)) +
  geom_histogram(binwidth=1,color="black", fill="white") +
  facet_wrap(~Year)

#how do these values vary spatially? Use latitude since that is more likely predicted to correlate with temp
ggplot(unique(dt.cover.txx[,.(Year,TransectID,val.mth,Lat.Cat)]), aes(x=val.mth,color=Lat.Cat,fill=Lat.Cat)) +
  geom_histogram(binwidth=1,alpha=0.5, position="identity") +
  facet_wrap(~Year)

##Hold off on this for now because there us limited variation in max temperature between sites (might be better for an anova model)

```

#Now create a model for TN90p. 

This is a monthly value for the percentage of days when TN > 90th percentile. I care about these values for the whole of winter, create a new value which either add or average these values for the winter months. 




Write out a long logic portion of the methods, so the model and what indices
