---
title: "Climate Data Organization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
library(data.table)
```

## Compile data into single data frame

```{r data-compilation}
setwd("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Monthly")

month_files <- list.files("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Monthly",full.names = T) 

month_files_name <- list.files("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Monthly",full.names = F)

indices.monthly = data.frame(Year = 1, Jan = 1,Feb = 1,Mar =1, Apr=1,May=1,Jun=1,Jul=1,Aug=1,Sep=1,Oct=1,Nov=1,Dec=1,Year = 1,TransectID=NA, Index = NA)

######Read each monthly csv and bind all into one data frame with necessary labels
for(i in 1:length(month_files)){
  data.ind <- read.csv(month_files[i],header = F,skip = 1)
  index <- rep(substr(month_files_name[i],1,nchar(month_files_name[i])-4),times=length(data.ind[,1]))
  binding = cbind(data.ind,index)
  names(binding) = names(indices.monthly)
  indices.monthly = rbind(indices.monthly,binding)
    }

indices.monthly = as.data.table(indices.monthly)

#remove placeholder row and duplicate year column
indices.monthly = indices.monthly[!1,]
indices.monthly[,Year.1:=NULL]

```

Now let's put this in long form to make analysis easier
```{r monthly-long-form}
head(indices.monthly)
indices.monthly.long = melt(indices.monthly,id=c("TransectID","Year","Index"),measure=2:(ncol(indices.monthly)-2))
head(indices.monthly.long)
setnames(indices.monthly.long, "variable", 'Month')

index.names = as.character(indices.monthly.long[,unique(Index)])



```

#Visualize the monthly indices 
Moved to other Rmd file for figure construction

##Index Key:
FD -Annual count of days when TN (daily minimum temperature) < 0°C  
SU - Annual count of days when TX (daily maximum temperature) > 25°C.  
ID - Annual count of days when TX (daily maximum temperature) < 0 °C.  
TR - Annual count of days when TN (daily minimum temperature) > 20 °C.   
GSL - Growing Season length. Annual* count between the first span of at least 6 days with daily mean temperature TG >5 °C and the first span after July 1st (Jan 1st in SH) of 6 days with TG <5 °C.  
TXx - Monthly maximum value of daily maximum temperature  
TNx - Monthly maximum value of daily minimum temperature  
TXn - Monthly minimum value of daily minimum temperature  
TNn - Monthly minimum value of daily minimum temperature  
TN10p - Percentage of days when TN < 10th percentile  
TX10p - Percentage of days when TX < 10th percentile  
TN90p - Percentage of days when TN > 90th percentile  
TX90p - Percentage of days when TX > 90th percentile  
WSDI - Warm spell duration index: annual count of days with at least 6 consecutive days when TX > 90th percentile  
CSDI - Cold spell duration index: annual count of days with at least 6 consecutive days when TN < 10th percentile  
DTR - Daily temperature range  
Rx1day - Monthly maximum 1-day precipitation  
Rx5day - Monthly maximum consecutive 5-day precipitation  
SDII - Simple precipitation intensity index  
R10mm - Annual count of days when PRCP ≥ 10mm  
R20mm - Annual count of days when PRCP ≥ 20mm  
Rnnmm - Annual count of days when PRCP ≥ nn mm, where nn is a user-defined threshold  
CDD - Maximum length of dry spell: maximum number of consecutive days with RR < 1mm  
CWD - Maximum length of wet spell: maximum number of consecutive days with RR ≥ 1mm  
R95p - Annual total PRCP when RR > 95th percentile  
R99p - Annual total PRCP when RR > 99th percentile  
PRCPTOT - Annual total precipitation on wet days  


##Compilation for yearly indices

```{r data compilation 2}
setwd("~/Documents/Grad School/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Yearly")

year_files <- list.files("~/Documents/Grad School/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Yearly",full.names = T) 

year_files_name <- list.files("~/Documents/Grad School/Thesis/Prairies/Data And Analysis/Climate/GMT/Indices-Yearly",full.names = F)

indices.yearly = data.frame()

######Read each monthly csv and bind all into one data frame with necessary labels
for(i in 1:length(year_files)){
  data.ind <- read.csv(year_files[i],header = F,skip = 1)
  index <- rep(substr(year_files_name[i],1,nchar(year_files_name[i])-4),times=length(data.ind[,1]))
  binding = cbind(data.ind,index)
  indices.yearly = rbind(indices.yearly,binding)
    }

Years = 1980:(1980+ncol(indices.yearly)-5)
colnames(indices.yearly) = c("Transect","Lat",'Lon',Years,"Index")  

```

Now let's put this in long form to make analysis easier
```{r yearly long form}
library(data.table)
head(indices.yearly)
indices.yearly.long = data.table(melt(indices.yearly,id=c("Transect","Index"),measure=4:(ncol(indices.yearly)-2)))
head(indices.yearly.long)
class(indices.yearly.long)
index.names = as.character(indices.yearly.long[,unique(Index)])
```

##Prepping and merging indices

See model indices selection logic for which ones we are using and why. Several of these need to be adjusted, averages, etc. and then all need to be appropriately merged to the cover file.

```{r indices prep}
indices.yearly=as.data.table(indices.yearly.long)
indices.monthly=as.data.table(indices.monthly.long)
setnames(indices.monthly,c("variable", "value","Index"),c("Year","val.mth","Index.m"),skip_absent=TRUE)
setnames(indices.yearly,c("variable", "value","Index"),c("Year","val.yr","Index.y"),skip_absent=TRUE)

#load in cover
#load data
cover=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Cover_data_model.csv",header = T)) 

#Create a new cover file to merge climate data into
cover.climate = cover

transect.master=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Transect_master_V2.csv",header = T)) #use V2 after data issue

z = transect.master[,.(Transect_I,TransectNa)]
setnames(z,c("Transect_I","TransectNa"),c("TransectID","Transect"))
indices.monthly = merge(indices.monthly,z, by = "Transect", all = T)
indices.monthly[,Transect:=NULL]
indices.yearly = merge(indices.yearly,z, by = "Transect", all = T)
indices.yearly[,Transect:=NULL]

indices.monthly$Year = as.integer(as.character(indices.monthly$Year))
indices.yearly$Year = as.integer(as.character(indices.yearly$Year))

###txx
txx = indices.monthly[Index.m=="txx" & Year>2008,.SD[which.max(val.mth)],by=.(Year,TransectID)]

#table(txx$Year,txx$Month) #See how max temperatures are divided between months each year. There is a case here for just taking txx for July...but August also has an impact.

#Merge txx with cover
txx[,Month:=NULL]
txx[,Index.m:=NULL]
txx[order(Year),txx.lag:= shift(val.mth), by =.(TransectID)]
cover.climate = merge(cover.climate,txx, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.mth",'txx')

###tn90p
#First sum tn90p values for winter "dormant" months, let's say Decemeber - March
tn90p = indices.monthly[Index.m=="tn90p" & Year>2008 & (Month =="Dec" | Month == "Jan" | Month == "Feb" | Month=="Mar"),sum(val.mth)/4,by=.(Year,TransectID)]
setnames(tn90p,"V1","tn90p")
tn90p[order(Year),tn90p.lag:= shift(tn90p), by =.(TransectID)]

#Merge tn90p with cover
cover.climate = merge(cover.climate,tn90p, by=c("Year","TransectID"),all.x = T)

###tx90p
#First sum tn90p values for winter "dormant" months, let's say Decemeber - March
tx90p = indices.monthly[Index.m=="tx90p" & Year>2008 & (Month =="Dec" | Month == "Jan" | Month == "Feb" | Month=="Mar"),sum(val.mth)/4,by=.(Year,TransectID)]
setnames(tx90p,"V1","tx90p")
tx90p[order(Year),tx90p.lag:= shift(tx90p), by =.(TransectID)]

#Merge tx90p with cover
cover.climate = merge(cover.climate,tx90p, by=c("Year","TransectID"),all.x = T)

###rx1
#I don't see what this will capture that rx5 will not, hold off for now

###rx5
#This is a monthly index, break out by seasons (Winter/Dormant,Spring, Summer/Fall) and also calculate yearly

#rx5.winter
rx5.w = indices.monthly[Index.m=="rx5day" & Year>2008 & (Month =="Dec" | Month == "Jan" | Month == "Feb" | Month=="Mar"),
                             .SD[which.max(val.mth)],by=.(Year,TransectID)]
rx5.w[,Month:=NULL]
rx5.w[,Index.m:=NULL]
rx5.w[order(Year),rx5.w.lag:= shift(val.mth), by =.(TransectID)]

cover.climate = merge(cover.climate,rx5.w, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.mth",'rx5.w')

#rx5.spring
rx5.sp = indices.monthly[Index.m=="rx5day" & Year>2008 & (Month =="Apr" | Month == "May"),
                             .SD[which.max(val.mth)],by=.(Year,TransectID)]
rx5.sp[,Month:=NULL]
rx5.sp[,Index.m:=NULL]
rx5.sp[order(Year),rx5.sp.lag:= shift(val.mth), by =.(TransectID)]

cover.climate = merge(cover.climate,rx5.sp, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.mth",'rx5.sp')

#rx5.summer
rx5.sum = indices.monthly[Index.m=="rx5day" & Year>2009 & (Month =="Jun" | Month == "Jul"| Month == "Aug"| Month == "Sep"),
                             .SD[which.max(val.mth)],by=.(Year,TransectID)]

rx5.sum[,Month:=NULL]
rx5.sum[,Index.m:=NULL]
rx5.sum[order(Year),rx5.sum.lag:= shift(val.mth), by =.(TransectID)]

cover.climate = merge(cover.climate,rx5.sum, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.mth",'rx5.sum')

#rx5.year
rx5.y = indices.monthly[Index.m=="rx5day" & Year>2008,
                             .SD[which.max(val.mth)],by=.(Year,TransectID)]

rx5.y[,Month:=NULL]
rx5.y[,Index.m:=NULL]
rx5.y[order(Year),rx5.y.lag:= shift(val.mth), by =.(TransectID)]

cover.climate = merge(cover.climate,rx5.y, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.mth",'rx5.y')

#Hugh, work on average T when I get the data, also SPEI

####The rest of the indices are yearly

###FD
fd = indices.yearly[Index.y=='fd' & Year>2008,.(Year,TransectID,val.yr)]
fd[order(Year),fd.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,fd, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'fd')

###GSL
gsl = indices.yearly[Index.y=='gsl' & Year>2008,.(Year,TransectID,val.yr)]
gsl[order(Year),gsl.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,gsl, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'gsl')

### WSDI
wsdi = indices.yearly[Index.y=='wsdi' & Year>2008,.(Year,TransectID,val.yr)]
wsdi[order(Year),wsdi.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,wsdi, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'wsdi')

### CSDI
csdi = indices.yearly[Index.y=='csdi' & Year>2008,.(Year,TransectID,val.yr)]
csdi[order(Year),csdi.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,csdi, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'csdi')

### SDII
sdii = indices.yearly[Index.y=='sdii' & Year>2008,.(Year,TransectID,val.yr)]
sdii[order(Year),sdii.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,sdii, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'sdii')

### CDD
cdd = indices.yearly[Index.y=='cdd' & Year>2008,.(Year,TransectID,val.yr)]
cdd[order(Year),cdd.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,cdd, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'cdd')

### CWD
cwd = indices.yearly[Index.y=='cwd' & Year>2008,.(Year,TransectID,val.yr)]
cwd[order(Year),cwd.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,cwd, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'cwd')

#prcptot
prcpt = indices.yearly[Index.y=='prcptot' & Year>2008,.(Year,TransectID,val.yr)]
prcpt[order(Year),prcpt.lag:= shift(val.yr), by =.(TransectID)]
cover.climate = merge(cover.climate,prcpt, by=c("Year","TransectID"),all.x = T)
setnames(cover.climate,"val.yr",'prcpt')

```



```{r Export}
setwd("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis")

library(data.table)

#Save indices files
fwrite(indices.yearly,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Yearly.csv")

fwrite(indices.monthly,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Indices_Monthly.csv")

#Save cover file with climate data
fwrite(cover.climate,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/cover_climate.csv")


```



