
---
title: "Prairie Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Close graphics and clear local memory
graphics.off()
rm(list=ls())

#load libraries
library(ggplot2)
library(plyr)
library(data.table)
library(AER)
library(sandwich)
library(foreign)
library(rmarkdown)

#load data
cover=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Cover_data_V2.csv",header = T)) #use V2 after data issue

transect.master=as.data.table(read.csv("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Transect_master_V2.csv",header = T)) #use V2 after data issue

lat = (cover[,max(StartLat)]-cover[,min(StartLat)])-3
long = (cover[,max(StartLong)]-cover[,min(StartLong)])-3

#Create a test latitude category
cover[,Lat.Cat:=ifelse(StartLat<cover[,min(StartLat)]+lat,yes = "South",no = ifelse(StartLat<cover[,min(StartLat)]+(2*lat),yes = "Middle",no = "North"))]

#Create a test longitude category
cover[,Long.Cat:=ifelse(StartLong<cover[,min(StartLong)]-long,yes = "West",no = ifelse(StartLong<cover[,min(StartLong)]-(2*long),yes = "Middle",no = "East"))]

```

Steps to complete first: 
- (complete) and merge species level data


#Species Richness Analysis
Calculate total richness (sr), native (nr), and invasive (ir) for all transects, mgmt units, and sites.

First create SR, NR, and IR counts based on plot level data, then mask out repetitive plot data. Come back and run first differences

```{r Species Richness}
#Compute native and non-native richness by transect, mgmt unit, site for each year
sr_tran=unique(cover[!(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
               [!(is.na(V1)),.(TransectID,Year,V1)])
setnames(sr_tran,"V1","sr_tran")

sr_mgmt=unique(cover[!(cov.2.T==0), length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
               [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])
setnames(sr_mgmt,"V1","sr_mgmt")

#sr_site=unique(cover[!(cov.2.T==0), sr_site:=length(unique(SpeciesID)), by = .(SITE_ID, Year)] [!(is.na(sr_site)),.(SITE_ID,Year,sr_site)])
#setnames(sr_site,"V1","sr_site")

ir_tran = unique(cover[Native.Status=="I" & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])
setnames(ir_tran,"V1","ir_tran")

ir_mgmt = unique(cover[Native.Status=="I" & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])
setnames(ir_mgmt,"V1","ir_mgmt")


ind_ir_tran = unique(cover[(Indicator=="I1" | Indicator=="I2") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_ir_tran,"V1","ind_ir_tran")
  
ind_ir_mgmt = unique(cover[(Indicator=="I1" | Indicator=="I2") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_ir_mgmt,"V1","ind_ir_mgmt")

ind_i1r_tran = unique(cover[(Indicator=="I1") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_i1r_tran,"V1","ind_i1r_tran")
  
ind_i1r_mgmt = unique(cover[(Indicator=="I1") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_i1r_mgmt,"V1","ind_i1r_mgmt")

ind_i2r_tran = unique(cover[(Indicator=="I2") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_i2r_tran,"V1","ind_i2r_tran")
  
ind_i2r_mgmt = unique(cover[(Indicator=="I2") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_i2r_mgmt,"V1","ind_i2r_mgmt")

#ir_site = unique(cover[Native.Status=="I" & !(cov.2.T==0), ir_site:=length(unique(SpeciesID)), by = .(SITE_ID, Year)]     [!(is.na(ir_site)),.(SITE_ID,Year,ir_site)])
#setnames(ir_site,"V1","ir_site")

nr_tran = unique(cover[Native.Status=="N" & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])
setnames(nr_tran,"V1","nr_tran")

nr_mgmt = unique(cover[Native.Status=="N" & !(cov.2.T==0), length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])
setnames(nr_mgmt,"V1","nr_mgmt")


ind_nr_tran = unique(cover[(Indicator=="N1" | Indicator=="N2") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_nr_tran,"V1","ind_nr_tran")
  
ind_nr_mgmt = unique(cover[(Indicator=="N1" | Indicator=="N2") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_nr_mgmt,"V1","ind_nr_mgmt")

ind_n1r_tran = unique(cover[(Indicator=="N1") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_n1r_tran,"V1","ind_n1r_tran")
  
ind_n1r_mgmt = unique(cover[(Indicator=="N1") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_n1r_mgmt,"V1","ind_n1r_mgmt")

ind_n2r_tran = unique(cover[(Indicator=="N2") & !(cov.2.T==0), length(unique(SpeciesID)), by = .(TransectID, Year)]
                 [!(is.na(V1)),.(TransectID,Year,V1)])

setnames(ind_n2r_tran,"V1","ind_n2r_tran")
  
ind_n2r_mgmt = unique(cover[(Indicator=="N2") & !(cov.2.T==0),length(unique(SpeciesID)), by = .(MGMTUNIT_I, Year)]
                 [!(is.na(V1)),.(MGMTUNIT_I,Year,V1)])

setnames(ind_n2r_mgmt,"V1","ind_n2r_mgmt")


#nr_site = unique(cover[Native.Status=="n" & !(cov.2.T==0), nr_site:=length(unique(SpeciesID)), by = .(SITE_ID, Year)]     [!(is.na(nr_site)),.(SITE_ID,Year,nr_site)])
#setnames(nr_site,"V1","nr_site")

#We no longer care about Plot level info, reduce the Cover file so save headaches later on
#Also do not care about plot level cover, this has been recalculated at the transect level
cover[,PlotID:=NULL]
cover[,Cover:=NULL]
cover[,Bin.1.1:=NULL]
cover[,Bin.1.2:=NULL]
cover[,Bin.2:=NULL]
cover[,Bin.3:=NULL]
cover[,Bin.4:=NULL]
cover=unique(cover)

##Merge all richness calcs
cover = merge(cover,sr_tran,by=c('TransectID','Year'))
cover = merge(cover,ir_tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,ind_ir_tran,by=c('TransectID','Year') ,all = T)
cover = merge(cover,ind_i1r_tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,ind_i2r_tran,by=c('TransectID','Year') ,all = T)
cover = merge(cover,nr_tran,by=c('TransectID','Year') ,all = T)
cover = merge(cover,ind_nr_tran,by=c('TransectID','Year') ,all = T)
cover = merge(cover,ind_n1r_tran,by=c('TransectID','Year') ,all = T)
cover = merge(cover,ind_n2r_tran,by=c('TransectID','Year') ,all = T)

cover = merge(cover,sr_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ir_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_ir_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_i1r_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_i2r_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,nr_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_nr_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_n1r_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)
cover = merge(cover,ind_n2r_mgmt,by=c('MGMTUNIT_I','Year') ,all = T)


```

Calculate SR by native/invasive/unknown status
```{r Richness differences}

## do first differences for sr
change_sr_tran=unique(cover[Delta==1 & !is.na(sr_tran),.(Year,TransectID,sr_tran)])
change_sr_mgmt=unique(cover[Delta==1 & !is.na(sr_mgmt),.(Year,MGMTUNIT_I,sr_mgmt)])
#change_sr_site=unique(cover[Delta==1& !is.na(sr_site),.(Year,SITE_ID,sr_site)])

change_sr_tran[order(Year), change_sr_tran := sr_tran-shift(sr_tran), by =.(TransectID)]
change_sr_mgmt[order(Year), change_sr_mgmt := sr_mgmt-shift(sr_mgmt), by =.(MGMTUNIT_I)]
#change_sr_site[order(Year), change_sr_site := sr_site-shift(sr_site), by =.(SITE_ID)]

cover = merge(cover,change_sr_tran,by=c("Year","TransectID","sr_tran"),all = T)
cover = merge(cover,change_sr_mgmt,by=c("Year","MGMTUNIT_I","sr_mgmt"),all=T)
#cover = merge(cover,change_sr_site,by=c("Year","SITE_ID","sr_site"),all=T)


###Additional metrics to add
# # average site richness over time
# cover[, ave_siterich := mean(site_richness, na.rm = TRUE), by = site_code]
# # average for the change year to year
# cover[, ave_siterich_change := mean(changerich, na.rm = TRUE), by = site_code]
# # initial site richness
# cover[, init_siterich := site_richness[year_trt == 0] ,  by = site_code]


## do first differences 
change_ir_tran=unique(cover[Delta==1 & !(is.na(ir_tran)),.(Year,TransectID,ir_tran)])
change_ir_mgmt=unique(cover[Delta==1 & !(is.na(ir_mgmt)),.(Year,MGMTUNIT_I,ir_mgmt)])
#change_ir_site=unique(cover[Delta==1 & !(is.na(ir_site)),.(Year,SITE_ID,ir_site)])

change_nr_tran=unique(cover[Delta==1 & !(is.na(nr_tran)),.(Year,TransectID,nr_tran)])
change_nr_mgmt=unique(cover[Delta==1 & !(is.na(nr_mgmt)),.(Year,MGMTUNIT_I,nr_mgmt)])
#change_nr_site=unique(cover[Delta==1 & !(is.na(nr_site)),.(Year,SITE_ID,nr_site)])

#change_ur_tran=unique(cover[Delta==1 & !(is.na(ur_tran)),.(Year,TransectID,ur_tran)])
#change_ur_mgmt=unique(cover[Delta==1 & !(is.na(ur_mgmt)),.(Year,MGMTUNIT_I,ur_mgmt)])
#change_ur_site=unique(cover[Delta==1 & !(is.na(ur_site)),.(Year,SITE_ID,ur_site)])

change_ir_tran[order(Year), change_ir_tran := ir_tran-shift(ir_tran), by =.(TransectID)]
change_ir_mgmt[order(Year), change_ir_mgmt := ir_mgmt-shift(ir_mgmt), by =.(MGMTUNIT_I)]
#change_ir_site[order(Year), change_ir_site := ir_site-shift(ir_site), by =.(SITE_ID)]

change_nr_tran[order(Year), change_nr_tran := nr_tran-shift(nr_tran), by =.(TransectID)]
change_nr_mgmt[order(Year), change_nr_mgmt := nr_mgmt-shift(nr_mgmt), by =.(MGMTUNIT_I)]
#change_nr_site[order(Year), change_nr_site := nr_site-shift(nr_site), by =.(SITE_ID)]

#change_ur_tran[order(Year), change_ur_tran := ur_tran-shift(ur_tran), by =.(TransectID)]
#change_ur_mgmt[order(Year), change_ur_mgmt := ur_mgmt-shift(ur_mgmt), by =.(MGMTUNIT_I)]
#change_ur_site[order(Year), change_ur_site := ur_site-shift(ur_site), by =.(SITE_ID)]

#Merge back to cover data

cover = merge(cover,change_ir_tran,by=c("Year","TransectID","ir_tran"),all = T)
cover = merge(cover,change_ir_mgmt,by=c("Year","MGMTUNIT_I","ir_mgmt"),all=T)
#cover = merge(cover,change_ir_site,by=c("Year","SITE_ID","ir_site"),all=T)

cover = merge(cover,change_nr_tran,by=c("Year","TransectID","nr_tran"),all = T)
cover = merge(cover,change_nr_mgmt,by=c("Year","MGMTUNIT_I","nr_mgmt"),all=T)
#cover = merge(cover,change_nr_site,by=c("Year","SITE_ID","nr_site"),all=T)

#cover = merge(cover,change_ur_tran,by=c("Year","TransectID","ur_tran"),all = T)
#cover = merge(cover,change_ur_mgmt,by=c("Year","MGMTUNIT_I","ur_mgmt"),all=T)
#cover = merge(cover,change_ur_site,by=c("Year","SITE_ID","ur_site"),all=T)

  
```


#Frequency Analysis
Frequency can be a useful proxy for abundance. It has already been calculated at the transect level (plots present in / 25 total plots).
Frequencies can't really be summed or averaged between species unless the species are grouped appropriately. Diversity and similarity metrics will do a better job of looking at aggregate frequency changes.

Another potentially useful way to think about frequency data will be to look at species frequency averaged across SITES and MGMT Units (can then categorize by region as a possible site effect...or something else)...HUGH this will be tricky to determine the denominator.

Visualize species frequency by: 
Delta 
- all species
- all species averaged a
- invasive vs. native
- indicator status

Average frequency for each transect & mgmt unit AND year by:
- invasive vs. native
- indicator status

Calculate first difference changes for these catagories. 

```{r Frequency All Species}

# Calculate Species level frequency
change_f.tran = unique(cover[!(Action=="") & Delta == 1, .(TransectID, SpeciesID, Freq.T,Year)])
change_f.mgmt = unique(cover[!(Action=="") & Delta == 1, .(MGMTUNIT_I, SpeciesID, Freq.M,Year)])

change_f.tran[order(Year), change_f.tran := Freq.T-shift(Freq.T), by =.(TransectID, SpeciesID)]
change_f.mgmt[order(Year), change_f.mgmt := Freq.M-shift(Freq.M), by =.(MGMTUNIT_I, SpeciesID)]

cover=merge(cover,change_f.tran,by=c("TransectID","SpeciesID","Freq.T","Year"),all = T)
cover=merge(cover,change_f.mgmt,by=c("MGMTUNIT_I","SpeciesID","Freq.M","Year"),all = T)


### Calculate yearly species-level frequency as an average across: everywhere, (sites & mgmt units already done). Then add delta values.

#everywhere, requires considering transects where species is not present as an absence
Freq.all =unique(cover[!(is.na(Freq.T)),.(Freq.T,Year,SpeciesID,TransectID)])
Freq.all = merge(Freq.all,cover[,length(unique(TransectID)),by=Year],by="Year", all=T) #essentially a transects observed count for that year
Freq.all[,Freq.all:=sum(Freq.T)/unique(V1), by = .(SpeciesID, Year)]
Freq.all[,V1:=NULL]

#delta all species frequency is a little different than the prior differences. I will average transect level differences rather than take the differences of Freq.all (which is already an average)
change_f.all = unique(cover[!(is.na(change_f.tran)),.(change_f.tran,Year,SpeciesID,TransectID)])
change_f.all[,change_f.all:=mean(change_f.tran),by=.(SpeciesID,Year)] #unlike Freq.all this does not use all transects observed that year as the denominator because change is dependent on prior years measured and NA values should not be assumed to be 0 (as they are with presence absence NA values for original frequency)

#Merge back onto cover
cover=merge(cover,Freq.all,by=c("Year","SpeciesID","Freq.T","TransectID"),all = T)
cover=merge(cover,change_f.all,by=c("Year","SpeciesID","change_f.tran","TransectID"),all = T)


```


```{r Frequency Categories}
#Calculate mean frequencies, have to do similar to with SR...AND unlike with delta freq I do not want zeros in these means
cover[Freq.T>0, allf.tran:=mean(Freq.T,na.rm=T), by = .(TransectID, Year)]
cover[Freq.T>0, allf.mgmt:=mean(Freq.M,na.rm=T), by = .(MGMTUNIT_I, Year)]

nf.tran = cover[Native.Status=="N" & Freq.T>0, mean(Freq.T,na.rm=T), by = .(TransectID, Year)]
setnames(nf.tran,"V1","nf.tran")

nf.mgmt = cover[Native.Status=="N" &Freq.T>0, mean(Freq.T,na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(nf.mgmt,"V1","nf.mgmt")

if.tran = cover[Native.Status=="I" & Freq.T>0, mean(Freq.T,na.rm=T), by = .(TransectID, Year)]
setnames(if.tran,"V1","if.tran")

if.mgmt = cover[Native.Status=="I" & Freq.T>0, mean(Freq.T,na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(if.mgmt,"V1","if.mgmt")

indf.n.tran = cover[(Indicator=="N1" | Indicator=="N2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.n.tran,"V1","indf.n.tran")

indf.n.mgmt = cover[(Indicator=="N1" | Indicator=="N2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.n.mgmt,"V1","indf.n.mgmt")

indf.n1.tran = cover[(Indicator=="N1") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.n1.tran,"V1","indf.n1.tran")

indf.n1.mgmt = cover[(Indicator=="N1") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.n1.mgmt,"V1","indf.n1.mgmt")

indf.n2.tran = cover[(Indicator=="N2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.n2.tran,"V1","indf.n2.tran")

indf.n2.mgmt = cover[(Indicator=="N2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.n2.mgmt,"V1","indf.n2.mgmt")

indf.i.tran = cover[(Indicator=="I1" | Indicator=="I2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.i.tran,"V1","indf.i.tran")

indf.i.mgmt = cover[(Indicator=="I1" | Indicator=="I2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.i.mgmt,"V1","indf.i.mgmt")

indf.i1.tran = cover[(Indicator=="I1") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.i1.tran,"V1","indf.i1.tran")

indf.i1.mgmt = cover[(Indicator=="I1") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.i1.mgmt,"V1","indf.i1.mgmt")

indf.i2.tran = cover[(Indicator=="I2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(TransectID, Year)]
setnames(indf.i2.tran,"V1","indf.i2.tran")

indf.i2.mgmt = cover[(Indicator=="I2") & Freq.T>0, mean(Freq.T, na.rm=T), by = .(MGMTUNIT_I, Year)]
setnames(indf.i2.mgmt,"V1","indf.i2.mgmt")


##Merge all frequency calcs
cover = merge(cover,if.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,nf.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.n.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.n1.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.n2.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.i.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.i1.tran,by=c('TransectID','Year'),all = T)
cover = merge(cover,indf.i2.tran,by=c('TransectID','Year'),all = T)

cover = merge(cover,if.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,nf.mgmt,by=c('MGMTUNIT_I','Year'))
cover = merge(cover,indf.n.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,indf.n1.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,indf.n2.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,indf.i.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,indf.i1.mgmt,by=c('MGMTUNIT_I','Year'),all = T)
cover = merge(cover,indf.i2.mgmt,by=c('MGMTUNIT_I','Year'),all = T)

# Calc first differences in a loop (go back and turn prior code into loop formate to speed coding)

#Create list of variables names for loop
freq.list = data.frame(freq = c("allf.tran", "allf.mgmt","nf.tran","nf.mgmt","if.tran","if.mgmt","indf.i.tran","indf.i.mgmt","indf.n.tran","indf.n.mgmt"))

freq.list$change = apply(freq.list,2,function(x) paste("change",freq.list$freq,sep = "_"))
colnames(freq.list[2])

for (i in 1:length(freq.list$freq)) {
  z = cover[,freq.list[i,1],with=FALSE]
  z = cbind(z,cover[,.(Year,TransectID,Delta)])[Delta==1,][!(is.na(eval(parse(text=(as.character(freq.list[i,1]))))))]
  z=unique(z[order(Year),])
  z[, paste(freq.list[i,2]) := eval(parse(text=(as.character(freq.list[i,1]))))-shift(eval(parse(text=(as.character(freq.list[i,1]))))),  
    by = .(TransectID)]
  z[,Delta:=NULL]
  cover = merge(cover,z,by = c("Year","TransectID",as.character(freq.list[i,1])),all = T)
}

colnames(freq.list[2]) = "change"
```

#Cover Analysis
Because of the binning methodology, this will be tricky. 

Binning reminder: 
Method 1 - Average bin values, to be compared between like years (2008-2012, 2015-2018)  
Method 2 - All years comparison (3 bins - <10, 11-50, 51-100) 
Method 3 - Compare 2013 or 2014 to 2015-2018  (11 bins - 1-5, 6-10, 11-20, 21-30, etc.)  
Method 4 - Compare 2013 and 2014 (13 bins - 1-3, 4-5, 6-10, 11-20, 21-30, etc..., 100%) UNLESS using Minneopa site (use wrong bins) 

Start with the most inclusive binning method... 2

Compare transect & Mgmt level coverage for: 
- each species relative to year, action, location
- Invasive and Native species - individual and mean coverage
- Indicator species -  individual and mean coverage

Then analyze change in coverage.

```{r Cover Analysis - Setup}
#Already calculated mean cover by transect and mgmt unit. Cover values should also have an appropriate zero after similar modifications for frequency

# HUGH....something is going on with average cover values for mgmt unit by methodology...some transect averages are not counting in one method but are for in the mgmt avg...see cover[TransectID==1977 & SpeciesID==5 & Year==2018,] as an example...I think I fixed this by removing plot and bins. Double check

#Calculate delta coverage for each species by transect and mgmt unit
cover.list = data.frame(
  cover = c("cov.1.1.T","cov.1.2.T","cov.2.T","cov.3.T","cov.4.T","cov.1.1.M","cov.1.2.M","cov.2.M","cov.3.M","cov.4.M"),
  Change = c("change_cov.1.1.T","change_cov.1.2.T","change_cov.2.T","change_cov.3.T","change_cov.4.T","change_cov.1.1.M","change_cov.1.2.M",
             "change_cov.2.M","change_cov.3.M","change_cov.4.M"))

for (i in 1:length(cover.list$cover)){
  z = cover[,cover.list[i,1],with=FALSE]
  z = cbind(z,cover[,.(Year,TransectID,Delta,SpeciesID)])[Delta==1,][!(is.na(eval(parse(text=(as.character(cover.list[i,1])))))),]
  z=unique(z[order(Year),])
  z[, paste(cover.list[i,2]) := eval(parse(text=(as.character(cover.list[i,1]))))-shift(eval(parse(text=(as.character(cover.list[i,1]))))),  
    by = .(TransectID, SpeciesID)]
  z[,Delta:=NULL]
  cover = merge(cover,z,by = c("Year","TransectID","SpeciesID",as.character(cover.list[i,1])),all = T)
}

#Calculate average cover for each transect and mgmt unit by native status and indicator...this might be too many variables to make into columns (5 methods * 10 species cat * 2 avgs)...can calculate and subset within plots/analysis, also averaging cover is less useful than relative cover below

```


#Create relative cover values

```{r Cover - Relative Cover}

#Make a relative cover for each species in each Transect, site, year
# First calculate TOTAL cover for each binning method, create a loop to do this. Then create relative cover = species cover/total cover

tot.cov.list = data.frame(cov=c("cov.1.1.T","cov.1.2.T","cov.2.T","cov.3.T","cov.4.T"),
                          tot.cov = c("tot.cov.T.1.1","tot.cov.T.1.2","tot.cov.T.2", "tot.cov.T.3", "tot.cov.T.4"),
                          rel.cov = c("rel.cov.T.1.1","rel.cov.T.1.2","rel.cov.T.2", "rel.cov.T.3", "rel.cov.T.4"))

for (i in 1:length(tot.cov.list$cov)) {
  z = unique(cover[,.(SpeciesID,TransectID,Year,eval(parse(text=(as.character(tot.cov.list[i,1])))))])
  z=z[!(is.na(V4)),]
  z[,as.character(tot.cov.list[i,2]):=sum(V4), by=.(TransectID,Year)]
  z[!(eval(parse(text=(as.character(tot.cov.list[i,2]))))==0),
    as.character(tot.cov.list[i,3]):=(V4/eval(parse(text=(as.character(tot.cov.list[i,2])))))]
  z[,V4:=NULL]
  cover = merge(cover, z, by = c("SpeciesID","TransectID","Year"),all = T)
}



#Sum up realtive cover by native status
rel.cov.i.1.1 = cover[Native.Status=="I",sum(rel.cov.T.1.1,na.rm = T),by=.(Year,TransectID)]
rel.cov.i.1.2 = cover[Native.Status=="I",sum(rel.cov.T.1.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.i.2 = cover[Native.Status=="I",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.i.3 = cover[Native.Status=="I",sum(rel.cov.T.3,na.rm = T),by=.(Year,TransectID)]
rel.cov.i.4 = cover[Native.Status=="I",sum(rel.cov.T.4,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.i.2 = cover[(Indicator=="I1" | Indicator == "I2"),sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.i1.2 = cover[Indicator=="I1",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.i2.2 = cover[Indicator=="I2",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]

setnames(rel.cov.i.1.1,"V1","rel.cov.i.1.1")
setnames(rel.cov.i.1.2,"V1","rel.cov.i.1.2")
setnames(rel.cov.i.2,"V1","rel.cov.i.2")
setnames(rel.cov.i.3,"V1","rel.cov.i.3")
setnames(rel.cov.i.4,"V1","rel.cov.i.4")
setnames(rel.cov.ind.i.2 ,"V1","rel.cov.ind.i.2")
setnames(rel.cov.ind.i1.2,"V1","rel.cov.ind.i1.2")
setnames(rel.cov.ind.i2.2 ,"V1","rel.cov.ind.i2.2")



rel.cov.n.1.1 = cover[Native.Status=="N",sum(rel.cov.T.1.1,na.rm = T),by=.(Year,TransectID)]
rel.cov.n.1.2 = cover[Native.Status=="N",sum(rel.cov.T.1.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.n.2 = cover[Native.Status=="N",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.n.3 = cover[Native.Status=="N",sum(rel.cov.T.3,na.rm = T),by=.(Year,TransectID)]
rel.cov.n.4 = cover[Native.Status=="N",sum(rel.cov.T.4,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.n.2 = cover[(Indicator=="N1" | Indicator == "N2"),sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.n1.2 = cover[Indicator=="N1",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]
rel.cov.ind.n2.2 = cover[Indicator=="N2",sum(rel.cov.T.2,na.rm = T),by=.(Year,TransectID)]

setnames(rel.cov.n.1.1,"V1","rel.cov.n.1.1")
setnames(rel.cov.n.1.2,"V1","rel.cov.n.1.2")
setnames(rel.cov.n.2,"V1","rel.cov.n.2")
setnames(rel.cov.n.3,"V1","rel.cov.n.3")
setnames(rel.cov.n.4,"V1","rel.cov.n.4")
setnames(rel.cov.ind.n.2 ,"V1","rel.cov.ind.n.2")
setnames(rel.cov.ind.n1.2,"V1","rel.cov.ind.n1.2")
setnames(rel.cov.ind.n2.2 ,"V1","rel.cov.ind.n2.2")

cover = merge(cover,rel.cov.i.1.1,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.i.1.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.i.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.i.3,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.i.4,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.i.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.i1.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.i2.2,by=c('TransectID','Year'),all = T)

cover = merge(cover,rel.cov.n.1.1,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.n.1.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.n.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.n.3,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.n.4,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.n.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.n1.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,rel.cov.ind.n2.2,by=c('TransectID','Year'),all = T)

```


# Dominance Variables 

Dominance indicator calculation ###
Use the dominance indicator metric from Avoilio et al (seperates dominance indication from impact)
   DI = (average relative abundance + relative frequency)/2
    Relative abundance = abundance(cover) of a species a in sampling unit / total abundance(cover) of all species in a sampling unit
    Relative frequency = number of sampling units a species occurred / total number of sampling units
note: ranges from 0-1; Relative abundance can be any measure of abundance. Does not incorporate a measure of impact.
There is not a cutoff for "which range from 0-1 = dominant species versus subordinate or rare, in the Avolio et al paper # 
so if we want to group species in these groups, we will need to make one (then also should test robustness to that decision)

```{r Dominance}
# DI = (relative cover + transect frequency)/2  # Compute for each binning method

DI.list = cbind(tot.cov.list,DI=c("DI.T.1.1","DI.T.1.2","DI.T.2","DI.T.3","DI.T.4"))

for (i in 1:length(DI.list$cov)) {
  z =unique(cover[!(is.na(eval(parse(text=(as.character(DI.list[i,3])))))),
           .(SpeciesID,Year,TransectID,Freq.T,eval(parse(text=(as.character(DI.list[i,3])))))])
  z[,as.character(DI.list[i,4]):=((Freq.T+V5)/2)]
  z[,V5:=NULL]
  cover = merge(cover,z, by = c("SpeciesID","TransectID","Year","Freq.T"),all = T)
  }
  

###Create a mean dominance by native status...only doing for Bin M 2 now
# I wondered if it would be better to take an actual value of Dominance for invasive (summing up invasive relative cover and invasive frequency, but at that point we are mostly just looking at invasive cover...the mean is likely more informative)


meanDI.i.tran.2 = cover[Native.Status=="I" & DI.T.2>0 ,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.i.tran.2 = cover[(Indicator=="I1" | Indicator == "I2") & DI.T.2>0 ,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.i1.tran.2 = cover[Indicator=="I1" & DI.T.2>0 ,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.i2.tran.2 = cover[Indicator=="I2" & DI.T.2>0 ,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]

meanDI.n.tran.2 = cover[Native.Status=="N" & DI.T.2>0,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.n.tran.2 = cover[(Indicator=="N1" | Indicator == "N2") & DI.T.2>0, mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.n1.tran.2 = cover[Indicator=="N1"  & DI.T.2>0,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]
meanDI.ind.n2.tran.2 = cover[Indicator=="N2"  & DI.T.2>0,mean(DI.T.2,na.rm=T), by = .(TransectID,Year)]

setnames(meanDI.n.tran.2,"V1","meanDI.n.tran.2")
setnames(meanDI.ind.n.tran.2,"V1","meanDI.ind.n.tran.2")
setnames(meanDI.ind.n1.tran.2,"V1","meanDI.ind.n1.tran.2")
setnames(meanDI.ind.n2.tran.2,"V1","meanDI.ind.n2.tran.2")

setnames(meanDI.i.tran.2,"V1","meanDI.i.tran.2")
setnames(meanDI.ind.i.tran.2,"V1","meanDI.ind.i.tran.2")
setnames(meanDI.ind.i1.tran.2,"V1","meanDI.ind.i1.tran.2")
setnames(meanDI.ind.i2.tran.2,"V1","meanDI.ind.i2.tran.2")


cover = merge(cover,meanDI.i.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.i.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.i1.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.i2.tran.2,by=c('TransectID','Year'),all = T)

cover = merge(cover,meanDI.n.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.n.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.n1.tran.2,by=c('TransectID','Year'),all = T)
cover = merge(cover,meanDI.ind.n2.tran.2,by=c('TransectID','Year'),all = T)

####### Make Categorical Variables of Dominance too ########

# Rank them in categories....Hugh right now lets use the same categories for all years even though cover measurements are different
# to look at changes in those types of species, which types of species are dominant?
## sub-ordinate and rare -- how can I compute this? ###########

######Something here is breaking my code

#cover[!(is.na(DI.T.1.1)), DIgroup:=cut(DI.T.1.1, breaks=c(0.0,0.2,0.7,1.0), labels=c("Rare","Subordinate","Dominant"))]
#cover[!(is.na(DI.T.1.2)), DIgroup:=cut(DI.T.1.2, breaks=c(0.0,0.2,0.7,1.0), labels=c("Rare","Subordinate","Dominant"))]
cover[, DIgroup:=cut(DI.T.2, breaks=c(-1,0.2,0.7,1.0), labels=c("Rare","Subordinate","Dominant"))]
#cover[!(is.na(DI.T.3)), DIgroup:=cut(DI.T.3, breaks=c(0.0,0.2,0.7,1.0), labels=c("Rare","Subordinate","Dominant"))]
#cover[!(is.na(DI.T.4)), DIgroup:=cut(DI.T.4, breaks=c(0.0,0.2,0.7,1.0), labels=c("Rare","Subordinate","Dominant"))]


#Create a initial dominance value each species...first year observed
DI.init = cover[,.SD[which.min(Year)], by = .(TransectID,SpeciesID)][,.(SpeciesID,TransectID,DIgroup)]
setnames(DI.init,"DIgroup","DIgroup.init")
cover = merge(cover,DI.init, by = c("SpeciesID",'TransectID'))

#richness in each group 
#cover[, sr_domspp := length(unique(Taxon[DIgroup == "Dominant"])), by = .(plot, site_code, year)]
#cover[, sr_rarespp := length(unique(Taxon[DIgroup == "Rare"])), by = .(plot, site_code, year)]
#cover[, sr_subordspp := length(unique(Taxon[DIgroup == "Subordinate"])), by = .(plot, site_code, year)]


# compute change in richness in each group 
#cover[order(year), change_sr_domspp := sr_domspp -shift(sr_domspp), by =.(plot, site_code)]
#cover[order(year), change_sr_rarespp := sr_rarespp -shift(sr_rarespp), by =.(plot, site_code)]
#cover[order(year), change_sr_subordspp := sr_subordspp -shift(sr_subordspp), by =.(plot, site_code)]

# lagged effects of sr in these groups
#cover[order(year), lagged_sr_rarespp := shift(sr_rarespp), by =.(plot, site_code)]
#cover[order(year), lagged_sr_domspp := shift(sr_domspp), by =.(plot, site_code)]
#cover[order(year), lagged_sr_subordspp := shift(sr_subordspp), by =.(plot, site_code)]



## Make a variable that captures changes in *cover* of species classified as dominance, rare, subordinate each year 
# (so we can look at variations from year to year)
#cover[, Dom_cover.yr := sum(relative_sp_cover.yr[DIgroup=="Dominant"]), by = .(plot, site_code, year)]
#cover[, Subord_cover.yr := sum(relative_sp_cover.yr[DIgroup=="Subordinate"]), by = .(plot, site_code, year)]
#cover[, Rare_cover.yr := sum(relative_sp_cover.yr[DIgroup=="Rare"]), by = .(plot, site_code, year)]


```


#Lagged Effects

Create lagged variables for the lagged effects models, i.e. how the the prior observed value informs the current value

```{r Lagged variables}
#Time variant Transect characteristics
cover[order(Year),VOR.lag:= shift(VOR), by =.(TransectID,SpeciesID)]
cover[order(Year),Litter.lag:= shift(Litter), by =.(TransectID,SpeciesID)]

#Richness
cover[order(Year),sr_tran.lag:= shift(sr_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),sr_mgmt.lag:= shift(sr_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),nr_tran.lag:= shift(nr_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),nr_mgmt.lag:= shift(nr_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_nr_tran.lag:= shift(ind_nr_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_nr_mgmt.lag:= shift(ind_nr_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_n1r_tran.lag:= shift(ind_n1r_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_n1r_mgmt.lag:= shift(ind_n1r_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_n2r_tran.lag:= shift(ind_n2r_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_n2r_mgmt.lag:= shift(ind_n2r_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ir_tran.lag:= shift(ir_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ir_mgmt.lag:= shift(ir_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_ir_tran.lag:= shift(ind_ir_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_ir_mgmt.lag:= shift(ind_ir_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_i1r_tran.lag:= shift(ind_i1r_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_i1r_mgmt.lag:= shift(ind_i1r_mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_i2r_tran.lag:= shift(ind_i2r_tran), by =.(TransectID,SpeciesID)]
cover[order(Year),ind_i2r_mgmt.lag:= shift(ind_i2r_mgmt), by =.(TransectID,SpeciesID)]

#Frequency
cover[order(Year),Freq.T.lag:= shift(Freq.T), by =.(TransectID,SpeciesID)]
cover[order(Year),Freq.M.lag:= shift(Freq.M), by =.(TransectID,SpeciesID)]
cover[order(Year),Freq.S.lag:= shift(Freq.S), by =.(TransectID,SpeciesID)]
cover[order(Year),Freq.all.lag:= shift(Freq.all), by =.(TransectID,SpeciesID)]

cover[order(Year),nf.tran.lag:= shift(nf.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),nf.mgmt.lag:= shift(nf.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),if.tran.lag:= shift(if.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),if.mgmt.lag:= shift(if.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),allf.tran.lag:= shift(allf.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),allf.mgmt.lag:= shift(allf.mgmt), by =.(TransectID,SpeciesID)]

cover[order(Year),indf.n.tran.lag:= shift(indf.n.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.n.mgmt.lag:= shift(indf.n.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.n1.tran.lag:= shift(indf.n1.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.n1.mgmt.lag:= shift(indf.n1.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.n2.tran.lag:= shift(indf.n2.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.n2.mgmt.lag:= shift(indf.n2.mgmt), by =.(TransectID,SpeciesID)]

cover[order(Year),indf.i.tran.lag:= shift(indf.i.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.i.mgmt.lag:= shift(indf.i.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.i1.tran.lag:= shift(indf.i1.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.i1.mgmt.lag:= shift(indf.i1.mgmt), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.i2.tran.lag:= shift(indf.i2.tran), by =.(TransectID,SpeciesID)]
cover[order(Year),indf.i2.mgmt.lag:= shift(indf.i2.mgmt), by =.(TransectID,SpeciesID)]


#Cover
cover[order(Year),cov.1.1.T.lag:= shift(cov.1.1.T), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.1.2.T.lag:= shift(cov.1.2.T), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.2.T.lag:= shift(cov.2.T), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.3.T.lag:= shift(cov.3.T), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.4.T.lag:= shift(cov.4.T), by =.(TransectID,SpeciesID)]

cover[order(Year),cov.1.1.M.lag:= shift(cov.1.1.M), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.1.2.M.lag:= shift(cov.1.2.M), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.2.M.lag:= shift(cov.2.M), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.3.M.lag:= shift(cov.3.M), by =.(TransectID,SpeciesID)]
cover[order(Year),cov.4.M.lag:= shift(cov.4.M), by =.(TransectID,SpeciesID)]

#Relative Cover
cover[order(Year),rel.cov.T.1.1.lag:= shift(rel.cov.T.1.1), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.T.1.2.lag:= shift(rel.cov.T.1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.T.2.lag:= shift(rel.cov.T.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.T.3.lag:= shift(rel.cov.T.3), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.T.4.lag:= shift(rel.cov.T.4), by =.(TransectID,SpeciesID)]

cover[order(Year),rel.cov.i.1.1.lag:= shift(rel.cov.i.1.1), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.i.1.2.lag:= shift(rel.cov.i.1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.i.2.lag:= shift(rel.cov.i.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.i.3.lag:= shift(rel.cov.i.3), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.i.4.lag:= shift(rel.cov.i.4), by =.(TransectID,SpeciesID)]

cover[order(Year),rel.cov.n.1.1.lag:= shift(rel.cov.n.1.1), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.n.1.2.lag:= shift(rel.cov.n.1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.n.2.lag:= shift(rel.cov.n.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.n.3.lag:= shift(rel.cov.n.3), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.n.4.lag:= shift(rel.cov.n.4), by =.(TransectID,SpeciesID)]

cover[order(Year),rel.cov.ind.i.2.lag:= shift(rel.cov.ind.i.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.ind.i1.2.lag:= shift(rel.cov.ind.i1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.ind.i2.2.lag:= shift(rel.cov.ind.i2.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.ind.n.2.lag:= shift(rel.cov.ind.n.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.ind.n1.2.lag:= shift(rel.cov.ind.n1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),rel.cov.ind.n2.2.lag:= shift(rel.cov.ind.n2.2), by =.(TransectID,SpeciesID)]

#DI
cover[order(Year),DI.T.1.1.lag:= shift(DI.T.1.1), by =.(TransectID,SpeciesID)]
cover[order(Year),DI.T.1.2.lag:= shift(DI.T.1.2), by =.(TransectID,SpeciesID)]
cover[order(Year),DI.T.2.lag:= shift(DI.T.2), by =.(TransectID,SpeciesID)]
cover[order(Year),DI.T.3.lag:= shift(DI.T.3), by =.(TransectID,SpeciesID)]
cover[order(Year),DI.T.4.lag:= shift(DI.T.4), by =.(TransectID,SpeciesID)]

cover[order(Year),meanDI.i.tran.2.lag:= shift(meanDI.i.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.i.tran.2.lag:= shift(meanDI.ind.i.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.i1.tran.2.lag:= shift(meanDI.ind.i1.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.i2.tran.2.lag:= shift(meanDI.ind.i2.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.n.tran.2.lag:= shift(meanDI.n.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.n.tran.2.lag:= shift(meanDI.ind.n.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.n1.tran.2.lag:= shift(meanDI.ind.n1.tran.2), by =.(TransectID,SpeciesID)]
cover[order(Year),meanDI.ind.n2.tran.2.lag:= shift(meanDI.ind.n2.tran.2), by =.(TransectID,SpeciesID)]
```

Species Group/Characteristic Calculations with lagged
```{r Group calcs}
#The above dt represents mean invasive values or species specific values, so to compare effects broken out by plant groups I need to create new columns for each one: Duration, Type, Legume, Photopath, Range, Distribution.

#Create individual group values for indicator classes

#Duration
cover[Freq.T>0,':='(f.T.dur = mean(Freq.T), rel.cov.2.dur = sum(rel.cov.T.2), meanDI.2.dur = mean(DI.T.2)),
      by = .(Year,Duration,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.dur = mean(Freq.T), rel.cov.2.ind.dur = sum(rel.cov.T.2), meanDI.2.ind.dur = mean(DI.T.2)),
      by = .(Year,Duration,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.dur = mean(Freq.T), rel.cov.2.indlvl.dur = sum(rel.cov.T.2), meanDI.2.indlvl.dur = mean(DI.T.2)),
      by = .(Year,Duration,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.dur = .N), by=.(Year,Duration,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Duration'),all = T)
cover[is.na(r.T.dur),r.T.dur:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.dur = .N), by=.(Year,Duration,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Duration'),all = T)
cover[is.na(r.ind.dur),r.ind.dur:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.dur = .N), by=.(Year,Duration,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Duration'),all = T)
cover[is.na(r.indlvl.dur),r.indlvl.dur:=0] 

##HUGH - The above comment leads to a potential issue. If there are two oberservation years with 0 values, is this relevant. One thought is that it is relevant, so zeros are needed, but in that case are all zeros relavant even for groups that never appear in a transect. This deals a bit with propagule pressure and establishment so is tricky. The other thought is that it is not relevant, so I can leave as NAs

cover[order(Year),':='(f.T.dur.lag = shift(f.T.dur), rel.cov.2.dur.lag = shift(rel.cov.2.dur), meanDI.2.dur.lag = shift(meanDI.2.dur)),by = .(Duration,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.dur.lag = shift(f.ind.dur), rel.cov.2.ind.dur.lag = shift(rel.cov.2.ind.dur), meanDI.2.ind.dur.lag = shift(meanDI.2.ind.dur)),by = .(Duration,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.dur.lag = shift(f.indlvl.dur), rel.cov.2.indlvl.dur.lag = shift(rel.cov.2.indlvl.dur), meanDI.2.indlvl.dur.lag = shift(meanDI.2.indlvl.dur)),by = .(Duration,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.dur.lag:=shift(r.T.dur),by = .(Duration,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.dur.lag:=shift(r.ind.dur),by = .(Duration,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.dur.lag:=shift(r.indlvl.dur),by = .(Duration,SpeciesID,TransectID,Indicator)]

#Type
cover[Freq.T>0,':='(f.T.type = mean(Freq.T), rel.cov.2.type = sum(rel.cov.T.2), meanDI.2.type = mean(DI.T.2)),
      by = .(Year,Type,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.type = mean(Freq.T), rel.cov.2.ind.type = sum(rel.cov.T.2), meanDI.2.ind.type = mean(DI.T.2)),
      by = .(Year,Type,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.type = mean(Freq.T), rel.cov.2.indlvl.type = sum(rel.cov.T.2), meanDI.2.indlvl.type = mean(DI.T.2)),
      by = .(Year,Type,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.type = .N), by=.(Year,Type,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Type'),all = T)
cover[is.na(r.T.type),r.T.type:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.type = .N), by=.(Year,Type,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Type'),all = T)
cover[is.na(r.ind.type),r.ind.type:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.type = .N), by=.(Year,Type,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Type'),all = T)
cover[is.na(r.indlvl.type),r.indlvl.type:=0] 

cover[order(Year),':='(f.T.type.lag = shift(f.T.type), rel.cov.2.type.lag = shift(rel.cov.2.type), meanDI.2.type.lag = shift(meanDI.2.type)),by = .(Type,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.type.lag = shift(f.ind.type), rel.cov.2.ind.type.lag = shift(rel.cov.2.ind.type), meanDI.2.ind.type.lag = shift(meanDI.2.ind.type)),by = .(Type,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.type.lag = shift(f.indlvl.type), rel.cov.2.indlvl.type.lag = shift(rel.cov.2.indlvl.type), meanDI.2.indlvl.type.lag = shift(meanDI.2.indlvl.type)),by = .(Type,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.type.lag:=shift(r.T.type),by = .(Type,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.type.lag:=shift(r.ind.type),by = .(Type,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.type.lag:=shift(r.indlvl.type),by = .(Type,SpeciesID,TransectID,Indicator)]

#Legume...Honesly I dont think I will use Legume, instead I want to create a new per transect and per year category of Legume Frequency
cover[Legume==1, ':='(leg.f.tran = mean(Freq.T)), by = .(TransectID, Year)]
cover[is.na(Legume), ':='(leg.f.tran = 0)]
cover[,':='(leg.f.tran = max(leg.f.tran)), by = .(TransectID, Year)]

cover[order(Year), ':='(leg.f.tran.lag = shift(leg.f.tran)), by = .(TransectID, Year)]


#Photopath
cover[Freq.T>0,':='(f.T.photo = mean(Freq.T), rel.cov.2.photo = sum(rel.cov.T.2), meanDI.2.photo = mean(DI.T.2)),
      by = .(Year,Photopath,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.photo = mean(Freq.T), rel.cov.2.ind.photo = sum(rel.cov.T.2), meanDI.2.ind.photo = mean(DI.T.2)),
      by = .(Year,Photopath,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.photo = mean(Freq.T), rel.cov.2.indlvl.photo = sum(rel.cov.T.2), meanDI.2.indlvl.photo = mean(DI.T.2)),
      by = .(Year,Photopath,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.photo = .N), by=.(Year,Photopath,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Photopath'),all = T)
cover[is.na(r.T.photo),r.T.photo:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.photo = .N), by=.(Year,Photopath,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Photopath'),all = T)
cover[is.na(r.ind.photo),r.ind.photo:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.photo = .N), by=.(Year,Photopath,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Photopath'),all = T)
cover[is.na(r.indlvl.photo),r.indlvl.photo:=0] 

cover[order(Year),':='(f.T.photo.lag = shift(f.T.photo), rel.cov.2.photo.lag = shift(rel.cov.2.photo), meanDI.2.photo.lag = shift(meanDI.2.photo)),by = .(Photopath,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.photo.lag = shift(f.ind.photo), rel.cov.2.ind.photo.lag = shift(rel.cov.2.ind.photo), meanDI.2.ind.photo.lag = shift(meanDI.2.ind.photo)),by = .(Photopath,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.photo.lag = shift(f.indlvl.photo), rel.cov.2.indlvl.photo.lag = shift(rel.cov.2.indlvl.photo), meanDI.2.indlvl.photo.lag = shift(meanDI.2.indlvl.photo)),by = .(Photopath,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.photo.lag:=shift(r.T.photo),by = .(Photopath,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.photo.lag:=shift(r.ind.photo),by = .(Photopath,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.photo.lag:=shift(r.indlvl.photo),by = .(Photopath,SpeciesID,TransectID,Indicator)]

#Range
cover[Freq.T>0,':='(f.T.range = mean(Freq.T), rel.cov.2.range = sum(rel.cov.T.2), meanDI.2.range = mean(DI.T.2)),
      by = .(Year,Range,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.range = mean(Freq.T), rel.cov.2.ind.range = sum(rel.cov.T.2), meanDI.2.ind.range = mean(DI.T.2)),
      by = .(Year,Range,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.range = mean(Freq.T), rel.cov.2.indlvl.range = sum(rel.cov.T.2), meanDI.2.indlvl.range = mean(DI.T.2)),
      by = .(Year,Range,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.range = .N), by=.(Year,Range,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Range'),all = T)
cover[is.na(r.T.range),r.T.range:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.range = .N), by=.(Year,Range,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Range'),all = T)
cover[is.na(r.ind.range),r.ind.range:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.range = .N), by=.(Year,Range,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Range'),all = T)
cover[is.na(r.indlvl.range),r.indlvl.range:=0] 

cover[order(Year),':='(f.T.range.lag = shift(f.T.range), rel.cov.2.range.lag = shift(rel.cov.2.range), meanDI.2.range.lag = shift(meanDI.2.range)),by = .(Range,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.range.lag = shift(f.ind.range), rel.cov.2.ind.range.lag = shift(rel.cov.2.ind.range), meanDI.2.ind.range.lag = shift(meanDI.2.ind.range)),by = .(Range,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.range.lag = shift(f.indlvl.range), rel.cov.2.indlvl.range.lag = shift(rel.cov.2.indlvl.range), meanDI.2.indlvl.range.lag = shift(meanDI.2.indlvl.range)),by = .(Range,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.range.lag:=shift(r.T.range),by = .(Range,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.range.lag:=shift(r.ind.range),by = .(Range,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.range.lag:=shift(r.indlvl.range),by = .(Range,SpeciesID,TransectID,Indicator)]

#Distribution
cover[Freq.T>0,':='(f.T.dist = mean(Freq.T), rel.cov.2.dist = sum(rel.cov.T.2), meanDI.2.dist = mean(DI.T.2)),
      by = .(Year,Distribution,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.dist = mean(Freq.T), rel.cov.2.ind.dist = sum(rel.cov.T.2), meanDI.2.ind.dist = mean(DI.T.2)),
      by = .(Year,Distribution,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.dist = mean(Freq.T), rel.cov.2.indlvl.dist = sum(rel.cov.T.2), meanDI.2.indlvl.dist = mean(DI.T.2)),
      by = .(Year,Distribution,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.dist = .N), by=.(Year,Distribution,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Distribution'),all = T)
cover[is.na(r.T.dist),r.T.dist:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.dist = .N), by=.(Year,Distribution,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Distribution'),all = T)
cover[is.na(r.ind.dist),r.ind.dist:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.dist = .N), by=.(Year,Distribution,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Distribution'),all = T)
cover[is.na(r.indlvl.dist),r.indlvl.dist:=0] 

cover[order(Year),':='(f.T.dist.lag = shift(f.T.dist), rel.cov.2.dist.lag = shift(rel.cov.2.dist), meanDI.2.dist.lag = shift(meanDI.2.dist)),by = .(Distribution,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.dist.lag = shift(f.ind.dist), rel.cov.2.ind.dist.lag = shift(rel.cov.2.ind.dist), meanDI.2.ind.dist.lag = shift(meanDI.2.ind.dist)),by = .(Distribution,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.dist.lag = shift(f.indlvl.dist), rel.cov.2.indlvl.dist.lag = shift(rel.cov.2.indlvl.dist), meanDI.2.indlvl.dist.lag = shift(meanDI.2.indlvl.dist)),by = .(Distribution,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.dist.lag:=shift(r.T.dist),by = .(Distribution,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.dist.lag:=shift(r.ind.dist),by = .(Distribution,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.dist.lag:=shift(r.indlvl.dist),by = .(Distribution,SpeciesID,TransectID,Indicator)]


#Season
cover[Freq.T>0,':='(f.T.season = mean(Freq.T), rel.cov.2.season = sum(rel.cov.T.2), meanDI.2.season = mean(DI.T.2)),
      by = .(Year,Season,TransectID,Native.Status)]

cover[Freq.T>0,':='(f.ind.season = mean(Freq.T), rel.cov.2.ind.season = sum(rel.cov.T.2), meanDI.2.ind.season = mean(DI.T.2)),
      by = .(Year,Season,TransectID,Ind.class)]

cover[Freq.T>0,':='(f.indlvl.season = mean(Freq.T), rel.cov.2.indlvl.season = sum(rel.cov.T.2), meanDI.2.indlvl.season = mean(DI.T.2)),
      by = .(Year,Season,TransectID,Indicator)]

cover = merge(cover,cover[Freq.T>0,.(r.T.season = .N), by=.(Year,Season,TransectID,Native.Status)], by =c('TransectID','Year','Native.Status','Season'),all = T)
cover[is.na(r.T.season),r.T.season:=0] #Because with these groups there will be years with zero species in the group, to adequate calculate lagged values we need these to be zeros, same goes for below

cover = merge(cover,cover[Freq.T>0,.(r.ind.season = .N), by=.(Year,Season,TransectID,Ind.class)], by =c('TransectID','Year','Ind.class','Season'),all = T)
cover[is.na(r.ind.season),r.ind.season:=0] 

cover = merge(cover,cover[Freq.T>0,.(r.indlvl.season = .N), by=.(Year,Season,TransectID,Indicator)], by =c('TransectID','Year','Indicator','Season'),all = T)
cover[is.na(r.indlvl.season),r.indlvl.season:=0] 

cover[order(Year),':='(f.T.season.lag = shift(f.T.season), rel.cov.2.season.lag = shift(rel.cov.2.season), meanDI.2.season.lag = shift(meanDI.2.season)),by = .(Season,TransectID,Native.Status,SpeciesID)]

cover[order(Year),':='(f.ind.season.lag = shift(f.ind.season), rel.cov.2.ind.season.lag = shift(rel.cov.2.ind.season), meanDI.2.ind.season.lag = shift(meanDI.2.ind.season)),by = .(Season,TransectID,Ind.class,SpeciesID)]

cover[order(Year),':='(f.indlvl.season.lag = shift(f.indlvl.season), rel.cov.2.indlvl.season.lag = shift(rel.cov.2.indlvl.season), meanDI.2.indlvl.season.lag = shift(meanDI.2.indlvl.season)),by = .(Season,TransectID,Indicator,SpeciesID)]

cover[order(Year),r.T.season.lag:=shift(r.T.season),by = .(Season,SpeciesID,TransectID,Native.Status)]

cover[order(Year),r.ind.season.lag:=shift(r.ind.season),by = .(Season,SpeciesID,TransectID,Ind.class)]

cover[order(Year),r.indlvl.season.lag:=shift(r.indlvl.season),by = .(Season,SpeciesID,TransectID,Indicator)]

```


#Finalize and Save data tables for model Rmd file
```{r Finish}

setwd("/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis")

#Save cover file
fwrite(cover,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Prairie Analysis/Prairie-Analysis/Cover_data_model.csv")

#Create smaller cover files for maps

#Map 1 - all years no species data....update with soils, system type
cover.map.1 = unique(cover[,.(TransectID,MGMTUNIT_I,SITE_ID,StartLat,StartLong,Protocol,ManUnitAcres)])
fwrite(cover.map.1,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Mapping/Data/cover.map.1.txt")

#Map 2 - Years & Actions......update with soils, system type
cover.map.2 = unique(cover[,.(TransectID,MGMTUNIT_I,SITE_ID,StartLat,StartLong,Protocol,ManUnitAcres,Action,Year,ir_tran,
                              nr_tran,indf.i.tran,indf.n.tran,if.tran,nf.tran)])
fwrite(cover.map.2,"/Volumes/GoogleDrive/My Drive/Thesis/Prairies/Data And Analysis/Mapping/Data/cover.map.2.txt")

```






